<!DOCTYPE html>
<html lang="pt-BR">
	<head>
		
<meta itemprop="name" content="Um ambiente simples usando Kubernetes e OpenShift Next Gen - Parte 2">
<meta itemprop="description" content="Uma vez que entendemos os conceitos básicos do Kubernetes na postagem anterior, vamos para uma demonstração de como utilizá-lo para montar uma aplicação simples">


<meta itemprop="datePublished" content="2017-03-08T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2017-03-08T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="956">

  <meta itemprop="image" content="http://www.lucassabreu.net.br/post/um-ambiente-simples-usando-kubernetes-e-openshift-next-gen-parte-1/header.png">



<meta itemprop="keywords" content="Openshift,Kubernetes,Introduction,Simple,Docker," />

		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<style type=text/css>body{font-family:monospace;}</style>
		<title>
	Um ambiente simples usando Kubernetes e OpenShift Next Gen - Parte 2 |
	Lucas dos Santos Abreu
</title>
		
		
		<link rel="stylesheet" href="/css/style.css?rnd=1631468566">
		
		
		<script src="https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.3.2/lazysizes.min.js" integrity="sha512-q583ppKrCRc7N5O0n2nzUiJ+suUv7Et1JGels4bXOaMFQcamPk9HjdUknZuuFjBNs7tsMuadge5k9RzdmO+1GQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
		<script src="/js/index.js"></script>
	</head>
	<body>
		<a class="skip-to-content-link" href="#main"> Skip to content </a>
		
<header class="page-header">
	
		<nav arial-label="primary" role="menu">
			
				
				<a
					href="/"
					
					>Home</a
				>
			
				
				<a
					href="/resume"
					
					>Resume</a
				>
			
				
				<a
					href="https://twitter.com/LucasSantAbreu"
					
					>Twitter</a
				>
			
				
				<a
					href="https://github.com/lucassabreu"
					
					>GitHub</a
				>
			
				
				<a
					href="https://medium.com/@lucassabreu"
					
					>Medium</a
				>
			
				
				<a
					href="https://www.linkedin.com/in/lucassantosabreu"
					
					>LinkedIn</a
				>
			
		</nav>
	
	
</header>

		
	<main id="main">
		<article>
			<header>
				<h1>Um ambiente simples usando Kubernetes e OpenShift Next Gen - Parte 2</h1>
				<p>
					
						<span class="reading-time">5 minute read</span>
					
					<span class="published-at">
						Published:
						<time
							>2017-03-08</time
						>
					</span>
				</p>
			</header>

			<div class="content" role="content">
				<p></p>

<figure class="big">
	<img class="lazyload blur-up" data-src="/post/um-ambiente-simples-usando-kubernetes-e-openshift-next-gen-parte-1/header.png" />
	
</figure>


<p>Este post é parte de uma série sobre o básico necessário para usar o Kubernetes, caso você não tenha lido os post anteriores recomendo lê-los e depois voltar aqui para não ficar perdido.</p>

<ul>
<li>Parte 1 - Conceitos Básicos: <a href="/post/um-ambiente-simples-usando-kubernetes-e-openshift-next-gen-parte-1">clique aqui</a></li>
<li>Parte 3 - Volumes Persistentes: <a href="/post/um-ambiente-simples-usando-kubernetes-e-openshift-next-gen-parte-3">clique aqui</a></li>
<li>Parte 4 - Segredos: <a href="/post/um-ambiente-simples-usando-kubernetes-e-openshift-next-gen-parte-4">clique aqui</a></li>
</ul>

<hr />

<p>Conhecendo os componentes básicos explicados no <a href="/post/um-ambiente-simples-usando-kubernetes-e-openshift-next-gen-parte-1">post anterior</a> posso preparar a aplicação que mostrei para o Kubernetes.</p>

<p>O primeiro passo é definir quais são os Pods do meu cluster.</p>

<p>Embora o primeiro impulso seja colocar cada um dos contêineres em um Pod distinto e seguir em frente, esse não é necessariamente a melhor forma de defini-los. Por exemplo, em situação certos contêineres tem o mesmo objetivo, ou dependem muito um do outro é uma boa ideia mantê-los juntos.</p>

<p>Mas para a minha aplicação faz mais sentido um Pod por contêiner, um para o servidor HTTP e outro para o banco de dados.</p>

<p>Como não é uma boa ideia simplesmente definir um Pod diretamente, criei dois Deployments o <code>node-deployment</code> e o <code>db-deployment</code>.</p>

<p><em>No momento da escrita desse post os Deployments ainda estavam marcados como uma versão beta, mas já são bastante usados, então é confiável.</em></p>

<pre><code class="language-yaml">apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: &quot;db-deployment&quot;
spec:
  replicas: 1
  template:
    metadata:
      labels:
        name: &quot;db-pod&quot;
    spec:
      containers:
        - name: &quot;db&quot;
          image: &quot;lucassabreu/openshift-mysql-test&quot;
          ports:
            - name: &quot;mysql-port&quot;
              containerPort: 3306
          env:
            - name: MYSQL_DATABASE
              value: appointments
            - name: MYSQL_ROOT_PASSWORD
              value: &quot;root&quot;
            - name: MYSQL_USER
              value: &quot;appoint&quot;
            - name: MYSQL_PASSWORD
              value: &quot;123&quot;
          volumeMounts:
            - name: &quot;mysql-volume&quot;
              mountPath: &quot;/var/lib/mysql&quot;
      volumes:
        - name: &quot;mysql-volume&quot;
</code></pre>

<p>O primeiro Deployment é para o <code>db-deployment</code>. Os arquivos de configuração são simples de ler, sempre começamos o arquivo dizendo o tipo de objeto que será criado, o <code>metadata</code> e definimos as <code>specs</code> (que variam para cada tipo de componente).</p>

<p>Defini que preciso de apenas um Pod (<code>replica</code>) e que as mesmas serão identificáveis pelas labels: <code>name=db-pod</code>.</p>

<p>Outras duas informações importantes são <code>ports</code> e <code>volumeMounts</code>.</p>

<ul>
<li><code>ports</code> define quais portas deverão ser expostas no Pod e permite que possam ser mapeadas nos Services posteriormente. Também é recomendado dar nomes às mesmas (<code>mysql-port</code>), assim podemos usar o nome como identificador no lugar de números.</li>
<li><code>volumeMounts</code> define todos os volumes do contêiner, dessa forma o volume de dados do MySQL precisou ser mapeado (<code>/var/lib/mysql</code>).</li>
</ul>

<pre><code class="language-yaml">apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: &quot;node-deployment&quot;
spec:
  replicas: 1
  template:
    metadata:
      labels:
        name: &quot;node-pod&quot;
    spec:
      containers:
        - name: &quot;node&quot;
          image: &quot;lucassabreu/openshift-app-test&quot;
          ports:
            - name: node-port
              containerPort: 8080
              protocol: TCP
          env:
            - name: DATABASE_CONNECTION
              value: mysql://appoint:123@db-service:3306/appointments
</code></pre>

<p>O segundo Deployment é do servidor HTTP, chamei-o de <code>node-deployment</code>. Ele segue as mesmas regras do anterior, sendo até mais simples.</p>

<p>A novidade aqui é o <code>db-service</code>, que vou explicar agora:</p>

<pre><code class="language-yaml">apiVersion: &quot;v1&quot;
kind: Service
metadata:
  name: &quot;db-service&quot;
spec:
  ports:
    - port: 3306
      targetPort: &quot;mysql-port&quot;
      protocol: TCP
  selector:
    name: &quot;db-pod&quot;
</code></pre>

<p>O <code>db-service</code> é o nome do Service que defini para agrupar os Pods de banco de dados, o Service ficou bem simples e basicamente tem duas partes:</p>

<ul>
<li><code>selector</code> define uma regra para selecionar quais Pods fazem parte do Service, no caso estou usando uma regra bem simples de <code>name=db-pod</code>.</li>
<li><code>ports</code> permite que você mapeie as portas dos Pods para uma porta no Service, no caso estou roteando a porta de nome <code>mysql-port</code> para a <code>3306</code> do Service. Assim toda chamada para <code>db-service:3306</code> será direcionada para a <code>mysql-port</code> de um dos Pods.</li>
</ul>

<pre><code class="language-yaml">apiVersion: &quot;v1&quot;
kind: Service
metadata:
  name: &quot;node-service&quot;
spec:
  ports:
    - port: 80
      targetPort: &quot;node-port&quot;
      protocol: TCP
  selector:
    name: &quot;node-pod&quot;
</code></pre>

<p>O <code>node-service</code> segue a mesma lógica, mas para os Pods do servidor HTTP.</p>

<pre><code class="language-yaml">apiVersion: v1
kind: Route
metadata:
  name: &quot;node-route&quot;
spec:
  to:
    kind: Service
    name: &quot;node-service&quot;
</code></pre>

<p>Por fim criei uma Route para expor o serviço <code>node-service</code> para a Internet. Eu poderia definir qual o nome de host, mas como não o fiz o OpenShift irá gerar uma URL automaticamente para mim.</p>

<p>Essa URL pode ser descoberta entrando na Dashboard do OpenShift ou com o comando <code>oc get routes</code>:</p>

<pre><code class="language-shell">$ oc get routes
NAME         HOST/PORT                                                  PATH      SERVICES       PORT      TERMINATION
node-route   node-route-medium-example.44fs.preview.openshiftapps.com             node-service   &lt;all&gt;
</code></pre>

<p>Para aplicar as configurações no cluster a OpenShift disponibiliza um cliente de linha de comando, que usa basicamente a mesma estrutura do <code>kubectl</code>, o <code>oc</code>. Então tudo que precisa ser feito é executar:</p>

<pre><code class="language-shell">oc apply -f db-deployment.yml,node-deployment.yml,db-srv.yml,node-srv.yml,node-route.yml
# Ou
oc apply -f db-deployment.yml
oc apply -f node-deployment.yml
oc apply -f db-srv.yml
oc apply -f node-srv.yml
oc apply -f node-route.yml
</code></pre>

<hr />

<p>As instruções de como instalar o cliente e configurá-lo estão nesse
link: <a href="https://console.preview.openshift.com/console/command-line">https://console.preview.openshift.com/console/command-line</a>.</p>

<hr />

<h4 id="update-2017-04-29">*** Update 2017–04–29 ***</h4>

<p>Se estiver lendo esse artigo algum tempo depois de lançado, a OpenShift fechou o preview e o link anterior não funciona, mas ainda é possível baixar o <code>oc</code> client em:</p>

<p><a href="https://github.com/openshift/origin/releases" title="https://github.com/openshift/origin/releases"><strong>openshift/origin</strong> origin - Enterprise Kubernetes for Developers</a></p>

<hr />

<p>Caso não queira criar os todos esses fontes, pode pegá-los aqui: <a href="https://github.com/lucassabreu/openshift-next-gen/tree/v1">https://github.com/lucassabreu/openshift-next-gen/tree/v1</a>; ou executar:</p>

<pre><code class="language-shell">git clone -b v1 \
    https://github.com/lucassabreu/openshift-next-gen.git
</code></pre>

<hr />

<p>Agora no console do OpenShift deverão aparecer todos esses componentes
rodando.</p>

<figure class="big">
	<img class="lazyload blur-up" data-src="/post/um-ambiente-simples-usando-kubernetes-e-openshift-next-gen-parte-2/openshift-dashboard.png" />
	
		<figcaption><p>eu fiz algumas brincadeiras antes de chegar aqui, então tenho mais versões dos deploys ☺</p></figcaption>
	
</figure>


<p>Caso esteja acompanhando as etapas, você já deve ter visto esse Dashboard, mas caso esteja apenas lendo: esse Dashboard é a tela principal dos clusters que você criar no OpenShift; basta clicar aqui, autenticar-se com o GitHub, criar um <strong>Project</strong>, e pronto em <strong>Overview</strong> você verá os componentes surgirem e sumirem em tempo real conforme vai aplicando as configurações.</p>

<p>Voltando, nesse momento temos o mesmo comportamento da aplicação local, rodando dentro do Kubernetes, empenhando o mínimo possível de configuração.</p>

<p>Mas existem alguns problemas no que foi definido.</p>

<p>O primeiro é que os <code>db-pods</code> estão totalmente efêmeros, ou seja, se eu adicionar novos dados nele, no momento que o Pod fosse destruído os dados iriam junto e sem backup !</p>

<p>Irei mostrar como resolver esse problema no próximo post.</p>

<p>Próximo Post: <a href="/post/um-ambiente-simples-usando-kubernetes-e-openshift-next-gen-parte-3/">clique aqui</a></p>
			</div><section class="share">
	<p>
		Share this post at
		<a
			href="https://twitter.com/share?text=Um%20ambiente%20simples%20usando%20Kubernetes%20e%20OpenShift%20Next%20Gen%e2%80%8a-%e2%80%8aParte%c2%a02&nbsp;-&nbsp;Lucas%20dos%20Santos%20Abreu&amp;url=http%3a%2f%2fwww.lucassabreu.net.br%2fpost%2fum-ambiente-simples-usando-kubernetes-e-openshift-next-gen-parte-2%2f"
			onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;"
		>
			Twitter
		</a>
		<a
			href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2fwww.lucassabreu.net.br%2fpost%2fum-ambiente-simples-usando-kubernetes-e-openshift-next-gen-parte-2%2f"
			onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;"
		>
			Facebook
		</a>
		<a
			href="http://pinterest.com/pin/create/button/?url=http%3a%2f%2fwww.lucassabreu.net.br%2fpost%2fum-ambiente-simples-usando-kubernetes-e-openshift-next-gen-parte-2%2f&amp;description=Um%20ambiente%20simples%20usando%20Kubernetes%20e%20OpenShift%20Next%20Gen%e2%80%8a-%e2%80%8aParte%c2%a02"
			onclick="window.open(this.href, 'pinterest-share','width=580,height=296');return false;"
		>
			Pinterest
		</a>
	</p>
</section>
<footer>
				
					<section role="comment">
						<p>
							<div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "lucas-dos-santos-abreu" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
						</p>
					</section>
				
				<section>
	<p>
		Published
		
			by <span itemprop="author"></span>
		
		<time
			datetime="2017-03-08T00:00:00&#43;00:00"
		>
			8 Mar, 2017
		</time>
		
		
			and tagged
			
				<a href="/tags/openshift">Openshift</a>
			
				<a href="/tags/kubernetes">Kubernetes</a>
			
				<a href="/tags/introduction">Introduction</a>
			
				<a href="/tags/simple">Simple</a>
			
				<a href="/tags/docker">Docker</a>
			
		
		using <span itemprop="wordCount">956</span> words.
	</p>
</section>

			</footer>
		</article>
	</main>
	
	



	<aside>
		<header>Related Content</header>
		<ul>
			
			
				<li>
					<a href="/post/ambientes-por-branch-com-openshift-next-gen-usando-github/">Ambientes por Branch com OpenShift Next Gen usando GitHub</a> &ndash;
					<time>9 minute read</time>
				</li>
			
				<li>
					<a href="/post/ambientes-por-branch-com-openshift-next-gen/">Ambientes por Branch com OpenShift Next Gen</a> &ndash;
					<time>9 minute read</time>
				</li>
			
				<li>
					<a href="/gist/coderockr-jam-2017-03/">Notas Kubernetes - Coderockr Jam 2017-03-11</a> &ndash;
					<time>5 minute read</time>
				</li>
			
				<li>
					<a href="/post/um-ambiente-simples-usando-kubernetes-e-openshift-next-gen-parte-4/">Um ambiente simples usando Kubernetes e OpenShift Next Gen - Parte 4</a> &ndash;
					<time>4 minute read</time>
				</li>
			
				<li>
					<a href="/post/um-ambiente-simples-usando-kubernetes-e-openshift-next-gen-parte-3/">Um ambiente simples usando Kubernetes e OpenShift Next Gen - Parte 3</a> &ndash;
					<time>4 minute read</time>
				</li>
			
				<li>
					<a href="/post/um-ambiente-simples-usando-kubernetes-e-openshift-next-gen-parte-1/">Um ambiente simples usando Kubernetes e OpenShift Next Gen - Parte 1</a> &ndash;
					<time>4 minute read</time>
				</li>
			
		</ul>
	</aside>



		<footer>
  <p>
    &copy;
    2021 ·
    
    
    This page was generated using <a target="_blank" rel="noopener" href="https://github.com/colorchestra/smol">smol<a> for <a target="_blank" rel="noopener" href="https://gohugo.io/">Hugo</a>.
  </p>
</footer>

	</body>
</html>
