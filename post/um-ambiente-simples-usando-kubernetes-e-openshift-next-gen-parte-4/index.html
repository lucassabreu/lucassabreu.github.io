<!DOCTYPE html>
<html lang="pt-BR">
	<head>
		
<meta itemprop="name" content="Um ambiente simples usando Kubernetes e OpenShift Next Gen - Parte 4">
<meta itemprop="description" content="Para completar a jornada vamos ver como o Kubernetes lida com dados sensíveis dentro da plataforma">


<meta itemprop="datePublished" content="2017-03-10T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2017-03-10T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="656">

  <meta itemprop="image" content="http://www.lucassabreu.net.br/post/um-ambiente-simples-usando-kubernetes-e-openshift-next-gen-parte-1/header.png">



<meta itemprop="keywords" content="Kubernetes,Openshift,Introduction,Simple,Docker," />

		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<style type=text/css>body{font-family:monospace;}</style>
		<title>
	Um ambiente simples usando Kubernetes e OpenShift Next Gen - Parte 4 |
	Lucas dos Santos Abreu
</title>
		
		
		<link rel="stylesheet" href="/css/style.css?rnd=1631468566">
		
		
		<script src="https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.3.2/lazysizes.min.js" integrity="sha512-q583ppKrCRc7N5O0n2nzUiJ+suUv7Et1JGels4bXOaMFQcamPk9HjdUknZuuFjBNs7tsMuadge5k9RzdmO+1GQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
		<script src="/js/index.js"></script>
	</head>
	<body>
		<a class="skip-to-content-link" href="#main"> Skip to content </a>
		
<header class="page-header">
	
		<nav arial-label="primary" role="menu">
			
				
				<a
					href="/"
					
					>Home</a
				>
			
				
				<a
					href="/resume"
					
					>Resume</a
				>
			
				
				<a
					href="https://twitter.com/LucasSantAbreu"
					
					>Twitter</a
				>
			
				
				<a
					href="https://github.com/lucassabreu"
					
					>GitHub</a
				>
			
				
				<a
					href="https://medium.com/@lucassabreu"
					
					>Medium</a
				>
			
				
				<a
					href="https://www.linkedin.com/in/lucassantosabreu"
					
					>LinkedIn</a
				>
			
		</nav>
	
	
</header>

		
	<main id="main">
		<article>
			<header>
				<h1>Um ambiente simples usando Kubernetes e OpenShift Next Gen - Parte 4</h1>
				<p>
					
						<span class="reading-time">4 minute read</span>
					
					<span class="published-at">
						Published:
						<time
							>2017-03-10</time
						>
					</span>
				</p>
			</header>

			<div class="content" role="content">
				<p></p>

<figure class="big">
	<img class="lazyload blur-up" data-src="/post/um-ambiente-simples-usando-kubernetes-e-openshift-next-gen-parte-1/header.png" />
	
</figure>


<p>Este post é a quarta parte de uma série sobre o básico necessário para usar o Kubernetes, caso você não tenha lido o post anterior recomendo lê-lo e depois voltar aqui para não ficar perdido.</p>

<ul>
<li>Parte 1 - Conceitos Básicos: <a href="/post/um-ambiente-simples-usando-kubernetes-e-openshift-next-gen-parte-1">clique aqui</a></li>
<li>Parte 2 - Construindo o Ambiente: <a href="/post/um-ambiente-simples-usando-kubernetes-e-openshift-next-gen-parte-2">clique aqui</a></li>
<li>Parte 3 - Volumes Persistentes: <a href="/post/um-ambiente-simples-usando-kubernetes-e-openshift-next-gen-parte-3">clique aqui</a></li>
</ul>

<hr />

<p>Como citei no <a href="/post/um-ambiente-simples-usando-kubernetes-e-openshift-next-gen-parte-3">post anterior</a> ainda existe um ponto de desconforto no ambiente, que é o fato das senhas e usuários estarem expostos diretamente nas configurações. O Kubernetes oferece uma solução para esse problema os <a href="https://kubernetes.io/docs/user-guide/secrets/"><strong>Secrets</strong></a>.</p>

<p>E agora irei mostrar como adicioná-los ao projeto.</p>

<p>Caso não tenha mais os fontes até o estado do post anterior, ou prefira acompanhar o meu andamento, pode pode pegá-los aqui: <a href="https://github.com/lucassabreu/openshift-next-gen/tree/v2">https://github.com/lucassabreu/openshift-next-gen/tree/v2</a>; ou executar:</p>

<pre><code class="language-shell">git clone -b v2 \
    https://github.com/lucassabreu/openshift-next-gen.git
</code></pre>

<hr />

<h4 id="secrets">Secrets</h4>

<p>Existem algumas formas de criar e usar os mesmos, criá-los diretamente de arquivos, ou usando configurações, e expô-los aos contêineres usando volumes ou variáveis de ambiente.</p>

<p>Para essa aplicação vou utilizar um YAML para definir um Secret e vou modificar os Pods para alimentarem as variáveis de ambiente com eles. A estrutura básica do Secret é como segue:</p>

<pre><code class="language-yaml">apiVersion: v1
kind: Secret
metadata:
  name: mysql-secrets
type: Opaque
data:
  mysql-root-password: &lt;hash base64&gt;
  mysql-user: &lt;hash base64&gt;
  mysql-password: &lt;hash base64&gt;
  mysql-database-connection: &lt;hash base64&gt;
</code></pre>

<p>Nele estou criando o Secret <code>mysql-secrets</code> e definindo quatro chaves que representam as três variáveis do MySQL e uma do servidor HTTP. No lugar do <code>&lt;hash base64&gt;</code> deve ir o conteúdo do segredo em Base 64, que pode ser gerado usando o comando <code>echo -n &quot;meusegredo&quot; | base64 -w0</code>.</p>

<p>Eu não gostei muito da ideia de guardar o Base 64 dentro da definição do Secret, então fiz a seguinte modificação no meu <code>mysql-secrets.yml</code>:</p>

<pre><code class="language-yaml">apiVersion: v1
kind: Secret
metadata:
  name: mysql-secrets
type: Opaque
data:
  mysql-root-password: %MYSQL_ROOT_PASSWORD
  mysql-user: %MYSQL_USER
  mysql-password: %MYSQL_PASSWORD
  mysql-database-connection: %DATABASE_CONNECTION
</code></pre>

<p>E quando vou aplicar o Secret no Kubernetes uso este script:</p>

<pre><code class="language-bash">MYSQL_ROOT_PASSWORD=$(&lt; /dev/urandom tr -dc _A-Z-a-z-0-9 | head -c${1:-32})
B64_MYSQL_ROOT_PASSWORD=$(echo -n $MYSQL_ROOT_PASSWORD | base64 -w0)
B64_DATABASE_USER=$(echo -n $DATABASE_USER | base64 -w0)
B64_DATABASE_PASSWORD=$(echo -n $DATABASE_PASSWORD | base64 -w0)
B64_DATABASE_CONNECTION=$(echo -n \
    &quot;mysql://$DATABASE_USER:$DATABASE_PASSWORD@db-service:3306/appointments&quot; \
    | base64 -w0)

sed &quot;\
  s|%MYSQL_ROOT_PASSWORD|$B64_MYSQL_ROOT_PASSWORD|;\
  s|%MYSQL_USER|$B64_DATABASE_USER|;\
  s|%MYSQL_PASSWORD|$B64_DATABASE_PASSWORD|;\
  s|%DATABASE_CONNECTION|$B64_DATABASE_CONNECTION|&quot; \
  mysql-secrets.yml | oc apply -f -
</code></pre>

<p>Esse script cria uma senha aleatória para o root e usa duas variáveis de ambiente para definir o usuário e senha do MySQL, faz o Base 64 deles, injeta eles no arquivo via <code>sed</code> no Secret e aplica no Kubernetes com <code>oc apply -f -</code> que irá ler a saída do <code>sed</code> e aplicá-la. Na hora de executar fica assim:</p>

<pre><code class="language-shell">$ export DATABASE_USER=appoint
$ export DATABASE_PASSWORD=123
$ ./env-set-oc.sh
secret &quot;mysql-secrets&quot; configured
</code></pre>

<p>Altero os Deployments para considerarem o Secret que criei:</p>

<pre><code class="language-yaml">apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: &quot;db-deployment&quot;
spec:
  replicas: 1
  template:
    metadata:
      labels:
        name: &quot;db-pod&quot;
    spec:
      containers:
        - name: &quot;db&quot;
          image: &quot;lucassabreu/openshift-mysql-test&quot;
          ports:
            - name: &quot;mysql-port&quot;
              containerPort: 3306
          env:
            - name: MYSQL_DATABASE
              value: appointments
            - name: MYSQL_ROOT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mysql-secrets
                  key: mysql-root-password
            - name: MYSQL_USER
              valueFrom:
                secretKeyRef:
                  name: mysql-secrets
                  key: mysql-user
            - name: MYSQL_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mysql-secrets
                  key: mysql-password
          volumeMounts:
            - name: &quot;mysql-persistent-volume&quot;
              mountPath: &quot;/var/lib/mysql&quot;
      volumes:
        - name: &quot;mysql-persistent-volume&quot;
          persistentVolumeClaim:
            claimName: mysql-pv-claim
</code></pre>

<p><small><center>db-deployment.yml</center></small></p>

<pre><code class="language-yaml">apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: &quot;node-deployment&quot;
spec:
  replicas: 1
  template:
    metadata:
      labels:
        name: &quot;node-pod&quot;
    spec:
      containers:
        - name: &quot;node&quot;
          image: &quot;lucassabreu/openshift-app-test&quot;
          ports:
            - name: node-port
              containerPort: 8080
              protocol: TCP
          env:
            - name: DATABASE_CONNECTION
              valueFrom:
                secretKeyRef:
                  name: mysql-secrets
                  key: mysql-database-connection
</code></pre>

<p><small><center>node-deployment.yml</center></small></p>

<p>A alteração consiste de trocar a chave <code>value</code> das variáveis por <code>valueFrom</code> e apontar para as chaves corretas dentro do Secret.</p>

<p>Depois que aplica as mudanças os Deployments vão identificá-las e trocar os Pods por novos. E passaram a utilizar os Secrets informado nas variáveis para eles.</p>

<hr />

<p>Ao final dessa séria, a conclusão que posso chegar é que o Kubernetes exige um conjunto razoavelmente grande de configurações para podermos servir uma aplicação, mas são arquivos simples de se entender e muito bem <a href="https://kubernetes.io/docs/reference/">documentados</a> o que facilitou bastante o processo, e não me fez sentir o peso dessa quantidade.</p>
			</div><section class="share">
	<p>
		Share this post at
		<a
			href="https://twitter.com/share?text=Um%20ambiente%20simples%20usando%20Kubernetes%20e%20OpenShift%20Next%20Gen%e2%80%8a-%e2%80%8aParte%c2%a04&nbsp;-&nbsp;Lucas%20dos%20Santos%20Abreu&amp;url=http%3a%2f%2fwww.lucassabreu.net.br%2fpost%2fum-ambiente-simples-usando-kubernetes-e-openshift-next-gen-parte-4%2f"
			onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;"
		>
			Twitter
		</a>
		<a
			href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2fwww.lucassabreu.net.br%2fpost%2fum-ambiente-simples-usando-kubernetes-e-openshift-next-gen-parte-4%2f"
			onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;"
		>
			Facebook
		</a>
		<a
			href="http://pinterest.com/pin/create/button/?url=http%3a%2f%2fwww.lucassabreu.net.br%2fpost%2fum-ambiente-simples-usando-kubernetes-e-openshift-next-gen-parte-4%2f&amp;description=Um%20ambiente%20simples%20usando%20Kubernetes%20e%20OpenShift%20Next%20Gen%e2%80%8a-%e2%80%8aParte%c2%a04"
			onclick="window.open(this.href, 'pinterest-share','width=580,height=296');return false;"
		>
			Pinterest
		</a>
	</p>
</section>
<footer>
				
					<section role="comment">
						<p>
							<div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "lucas-dos-santos-abreu" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
						</p>
					</section>
				
				<section>
	<p>
		Published
		
			by <span itemprop="author"></span>
		
		<time
			datetime="2017-03-10T00:00:00&#43;00:00"
		>
			10 Mar, 2017
		</time>
		
		
			and tagged
			
				<a href="/tags/kubernetes">Kubernetes</a>
			
				<a href="/tags/openshift">Openshift</a>
			
				<a href="/tags/introduction">Introduction</a>
			
				<a href="/tags/simple">Simple</a>
			
				<a href="/tags/docker">Docker</a>
			
		
		using <span itemprop="wordCount">656</span> words.
	</p>
</section>

			</footer>
		</article>
	</main>
	
	



	<aside>
		<header>Related Content</header>
		<ul>
			
			
				<li>
					<a href="/post/ambientes-por-branch-com-openshift-next-gen-usando-github/">Ambientes por Branch com OpenShift Next Gen usando GitHub</a> &ndash;
					<time>9 minute read</time>
				</li>
			
				<li>
					<a href="/post/ambientes-por-branch-com-openshift-next-gen/">Ambientes por Branch com OpenShift Next Gen</a> &ndash;
					<time>9 minute read</time>
				</li>
			
				<li>
					<a href="/gist/coderockr-jam-2017-03/">Notas Kubernetes - Coderockr Jam 2017-03-11</a> &ndash;
					<time>5 minute read</time>
				</li>
			
				<li>
					<a href="/post/um-ambiente-simples-usando-kubernetes-e-openshift-next-gen-parte-3/">Um ambiente simples usando Kubernetes e OpenShift Next Gen - Parte 3</a> &ndash;
					<time>4 minute read</time>
				</li>
			
				<li>
					<a href="/post/um-ambiente-simples-usando-kubernetes-e-openshift-next-gen-parte-2/">Um ambiente simples usando Kubernetes e OpenShift Next Gen - Parte 2</a> &ndash;
					<time>5 minute read</time>
				</li>
			
				<li>
					<a href="/post/um-ambiente-simples-usando-kubernetes-e-openshift-next-gen-parte-1/">Um ambiente simples usando Kubernetes e OpenShift Next Gen - Parte 1</a> &ndash;
					<time>4 minute read</time>
				</li>
			
		</ul>
	</aside>



		<footer>
  <p>
    &copy;
    2021 ·
    
    
    This page was generated using <a target="_blank" rel="noopener" href="https://github.com/colorchestra/smol">smol<a> for <a target="_blank" rel="noopener" href="https://gohugo.io/">Hugo</a>.
  </p>
</footer>

	</body>
</html>
