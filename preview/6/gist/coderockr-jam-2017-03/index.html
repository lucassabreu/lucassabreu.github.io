<!doctype html><html lang=pt-br>
<head>
<meta itemprop=name content="Notas Kubernetes - Coderockr Jam 2017-03-11">
<meta itemprop=description content="Algumas notas e detalhes que anotei sobre o Kubernetes para o Coderockr Jam"><meta itemprop=datePublished content="2017-03-11T00:00:00+00:00">
<meta itemprop=dateModified content="2017-03-11T00:00:00+00:00">
<meta itemprop=wordCount content="1004">
<meta itemprop=keywords content="Coderockr Jam,Kubernetes,Basics,">
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta http-equiv=x-ua-compatible content="IE=edge">
<style type=text/css>body{font-family:monospace}</style>
<title>
Notas Kubernetes - Coderockr Jam 2017-03-11 |
Lucas dos Santos Abreu
</title>
<link rel=stylesheet href="/preview/6/css/style.css?rnd=1633789666">
<script src="/preview/6/js/index.js?rnd=1633789666"></script>
</head>
<body>
<a class=skip-to-content-link href=#main> Skip to content </a>
<header class=page-header>
<nav arial-label=primary role=menu>
<a href=/preview/6/preview/6/>Home</a>
<a href=/preview/6/preview/6/resume>Resume</a>
<a href=https://twitter.com/LucasSantAbreu>Twitter</a>
<a href=https://github.com/lucassabreu>GitHub</a>
<a href=https://medium.com/@lucassabreu>Medium</a>
<a href=https://www.linkedin.com/in/lucassantosabreu>LinkedIn</a>
</nav>
</header>
<main id=main>
<article>
<header>
<h1>Notas Kubernetes - Coderockr Jam 2017-03-11</h1>
<p>
<span class=reading-time>5 minute read</span>
<span class=published-at>
Published:
<time datetime="2017-03-11 00:00:00 +0000 UTC">2017-03-11</time>
</span>
</p>
</header>
<div class=content role=content>
<figure class=big>
<img class="lazyload blur-up" loading=lazy data-src=https://upload.wikimedia.org/wikipedia/en/0/00/Kubernetes_%28container_engine%29.png>
</figure>
<p>Kubernetes ou K8s é uma plataforma open source para gestão de cluster de contêineres, desenvolvido pelo Google e doado a <em>Cloud Native Computing Foundation</em>, que é uma organização que existe abaixo do <em>Linux Foundation</em>.</p>
<p>Tem por objetivo a automoção de um conjunto de funções de cluster: deploy, escalagem e executar aplicações de contêineres em vários hosts. Sendo que normalmente funciona usando <em>Docker</em>.</p>
<p>Alguns conceitos importantes para entender a ferramenta:</p>
<h2 id=pods>
Pods
<a href=#pods class=heading-anchor><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" xmlns:xlink="http://www.w3.org/1999/xlink" enable-background="new 0 0 512 512"><g><g><g><path d="M480.7 11H130.4c-11.3.0-20.4 9.1-20.4 20.4v60.3H31.5c-11.3.0-20.4 9.1-20.4 20.4v368.5c0 11.3 9.1 20.4 20.4 20.4h350.3c11.3.0 20.4-9.1 20.4-20.4v-60.3h78.5c11.3.0 20.4-9.1 20.4-20.4V31.4C501.1 20.1 491.9 11 480.7 11zM361.3 460.2H51.9V132.5h309.4V460.2zm98.9-80.7h-58.1V112.1c0-11.3-9.1-20.4-20.4-20.4h-231V51.8h309.4V379.5z"/><path d="m127.8 242.6h157.7c11.3.0 20.4-9.1 20.4-20.4s-9.1-20.4-20.4-20.4H127.8c-11.3.0-20.4 9.1-20.4 20.4s9.1 20.4 20.4 20.4z"/><path d="m127.8 390.9h157.7c11.3.0 20.4-9.1 20.4-20.4.0-11.3-9.1-20.4-20.4-20.4H127.8c-11.3.0-20.4 9.1-20.4 20.4.0 11.2 9.1 20.4 20.4 20.4z"/></g></g></g></svg>
</a>
</h2>
<p>São o menor componente do K8s, definindo um nó do cluster, ou seja, uma máquina virtual dedicada apenas as funções definidas nela, com o acréscimo de alguns componentes para verificar estado e vida das aplicações sendo executadas dentro delas.</p>
<p>Um <code>Pod</code> irá executar um conjunto de contêineres definidos nele e que devem ter a mesma finalidade ou estão ligados de uma forma tão forte que se um falhar os contêineres relacionados devem ser destruídos também.</p>
<p>Também tem a caracteristica de serem tratados como efêmeros, de modo que destruí-los e recriá-los deve ser uma tarefa simples e sem remorços.</p>
<h2 id=persistent-volume-claim-pvc>
Persistent Volume Claim (PVC)
<a href=#persistent-volume-claim-pvc class=heading-anchor><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" xmlns:xlink="http://www.w3.org/1999/xlink" enable-background="new 0 0 512 512"><g><g><g><path d="M480.7 11H130.4c-11.3.0-20.4 9.1-20.4 20.4v60.3H31.5c-11.3.0-20.4 9.1-20.4 20.4v368.5c0 11.3 9.1 20.4 20.4 20.4h350.3c11.3.0 20.4-9.1 20.4-20.4v-60.3h78.5c11.3.0 20.4-9.1 20.4-20.4V31.4C501.1 20.1 491.9 11 480.7 11zM361.3 460.2H51.9V132.5h309.4V460.2zm98.9-80.7h-58.1V112.1c0-11.3-9.1-20.4-20.4-20.4h-231V51.8h309.4V379.5z"/><path d="m127.8 242.6h157.7c11.3.0 20.4-9.1 20.4-20.4s-9.1-20.4-20.4-20.4H127.8c-11.3.0-20.4 9.1-20.4 20.4s9.1 20.4 20.4 20.4z"/><path d="m127.8 390.9h157.7c11.3.0 20.4-9.1 20.4-20.4.0-11.3-9.1-20.4-20.4-20.4H127.8c-11.3.0-20.4 9.1-20.4 20.4.0 11.2 9.1 20.4 20.4 20.4z"/></g></g></g></svg>
</a>
</h2>
<p>São volumes de dados persistentes, como os <code>Pods</code> tem a caracterica de serem criados e destruídos a qualquer momento existe o risco de perder seus dados, os <code>Persistent Volume Claims</code> tem por objetivo cobrir esse problema provendo storages que sobrevivem sem os <code>Pods</code>, assim quando o <code>Pod</code> for criado poderá se conectar ao mesmo <code>PVC</code> e continuar.</p>
<p>Existem vários tipos de drivers de armazenamento para os <code>PVCs</code> utilizarem, mas que normalmente dependem do serviço provendo o K8s, por exemplo, o OpenShift apenas provê o EBS do AWS, mas no Google Cloud podem ser usados storages do Google, AWS, locais, etc.</p>
<h2 id=cron-jobs>
Cron Jobs
<a href=#cron-jobs class=heading-anchor><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" xmlns:xlink="http://www.w3.org/1999/xlink" enable-background="new 0 0 512 512"><g><g><g><path d="M480.7 11H130.4c-11.3.0-20.4 9.1-20.4 20.4v60.3H31.5c-11.3.0-20.4 9.1-20.4 20.4v368.5c0 11.3 9.1 20.4 20.4 20.4h350.3c11.3.0 20.4-9.1 20.4-20.4v-60.3h78.5c11.3.0 20.4-9.1 20.4-20.4V31.4C501.1 20.1 491.9 11 480.7 11zM361.3 460.2H51.9V132.5h309.4V460.2zm98.9-80.7h-58.1V112.1c0-11.3-9.1-20.4-20.4-20.4h-231V51.8h309.4V379.5z"/><path d="m127.8 242.6h157.7c11.3.0 20.4-9.1 20.4-20.4s-9.1-20.4-20.4-20.4H127.8c-11.3.0-20.4 9.1-20.4 20.4s9.1 20.4 20.4 20.4z"/><path d="m127.8 390.9h157.7c11.3.0 20.4-9.1 20.4-20.4.0-11.3-9.1-20.4-20.4-20.4H127.8c-11.3.0-20.4 9.1-20.4 20.4.0 11.2 9.1 20.4 20.4 20.4z"/></g></g></g></svg>
</a>
</h2>
<p>Um problema para contêineres é a execução de CRONs, que é por muitos considerado uma má prática gerenciar internamente ao contêiner, que o certo seria o host do contêiner instanciá-lo temporariamente para executar o comando. Assim a responsabidade de schedule da CRON ficaria para o host.</p>
<p><code>CRON Jobs</code> representam a solução do K8s para isso, podem ser criadas schedules de execução de <code>Pods</code> do tipo <code>Job</code> que irão ser iniciados, executam uma tarefa e morrem.</p>
<p>Caso ocorram falhas ou insucesso na execução um novo <code>Job</code> será criado para tentar concluir a tarefa, se assim for configurado.</p>
<h2 id=labels-e-selectors>
Labels e Selectors
<a href=#labels-e-selectors class=heading-anchor><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" xmlns:xlink="http://www.w3.org/1999/xlink" enable-background="new 0 0 512 512"><g><g><g><path d="M480.7 11H130.4c-11.3.0-20.4 9.1-20.4 20.4v60.3H31.5c-11.3.0-20.4 9.1-20.4 20.4v368.5c0 11.3 9.1 20.4 20.4 20.4h350.3c11.3.0 20.4-9.1 20.4-20.4v-60.3h78.5c11.3.0 20.4-9.1 20.4-20.4V31.4C501.1 20.1 491.9 11 480.7 11zM361.3 460.2H51.9V132.5h309.4V460.2zm98.9-80.7h-58.1V112.1c0-11.3-9.1-20.4-20.4-20.4h-231V51.8h309.4V379.5z"/><path d="m127.8 242.6h157.7c11.3.0 20.4-9.1 20.4-20.4s-9.1-20.4-20.4-20.4H127.8c-11.3.0-20.4 9.1-20.4 20.4s9.1 20.4 20.4 20.4z"/><path d="m127.8 390.9h157.7c11.3.0 20.4-9.1 20.4-20.4.0-11.3-9.1-20.4-20.4-20.4H127.8c-11.3.0-20.4 9.1-20.4 20.4.0 11.2 9.1 20.4 20.4 20.4z"/></g></g></g></svg>
</a>
</h2>
<p>Labels é a forma pela qual os componentes (principalmente <code>Pods</code>) são marcados e agrupados, através destas marcações e nada mais Services e Controllers identificam seus <code>Pods</code>, de forma que uma estruturação ruim de labels/selectors pode levar a Services tentando acessar <code>Pods</code> inválidos e Controllers competirem por definições de <code>Pods</code>.</p>
<h2 id=controllers>
Controllers
<a href=#controllers class=heading-anchor><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" xmlns:xlink="http://www.w3.org/1999/xlink" enable-background="new 0 0 512 512"><g><g><g><path d="M480.7 11H130.4c-11.3.0-20.4 9.1-20.4 20.4v60.3H31.5c-11.3.0-20.4 9.1-20.4 20.4v368.5c0 11.3 9.1 20.4 20.4 20.4h350.3c11.3.0 20.4-9.1 20.4-20.4v-60.3h78.5c11.3.0 20.4-9.1 20.4-20.4V31.4C501.1 20.1 491.9 11 480.7 11zM361.3 460.2H51.9V132.5h309.4V460.2zm98.9-80.7h-58.1V112.1c0-11.3-9.1-20.4-20.4-20.4h-231V51.8h309.4V379.5z"/><path d="m127.8 242.6h157.7c11.3.0 20.4-9.1 20.4-20.4s-9.1-20.4-20.4-20.4H127.8c-11.3.0-20.4 9.1-20.4 20.4s9.1 20.4 20.4 20.4z"/><path d="m127.8 390.9h157.7c11.3.0 20.4-9.1 20.4-20.4.0-11.3-9.1-20.4-20.4-20.4H127.8c-11.3.0-20.4 9.1-20.4 20.4.0 11.2 9.1 20.4 20.4 20.4z"/></g></g></g></svg>
</a>
</h2>
<p><code>Constrollers</code> são regras de replicação e deploy que existem para os <code>Pods</code> dentro do K8s, eles tem por objetivo realizar a tarefa de deployment, escalagem, verificar vida dos contêineres e eventualmente destruí-los quando param de responder.</p>
<p>Existem alguns tipos de <code>Controllers</code>, mas de forma geral eles trabalham mantendo conjuntos de contêineres com determidas definições ativos e criar novos de acordo com regras. Os <code>Controllers</code> irão criar ou adotar conjuntos <code>Pods</code> que teram uma mesma marcação de <code>labels</code>/<code>selectors</code> e possuem um &ldquo;template&rdquo; de <code>Pods</code> dentro deles para saberem como criá-los quando necessário.</p>
<p>Os tipos possíveis são:</p>
<ul>
<li><strong>ReplicationController</strong>: é o mais simples dos <code>Controllers</code>, realizando apenas deploy, escalonamento de Pods e verificando disponibilidade dos mesmos, quando existem <code>Pods</code> orfãs que se encaixam em seus selectors eles os acolhem e consideram válidos, mesmo que estes não respeitem seu modelo de <code>Pods</code>. São o tipo mais simples de <code>Controllers</code> é sugerido dar preferencia aos <code>Deployments</code> no lugar deles.</li>
<li><strong>Deployment</strong>: é um <code>Controller</code> semelhante ao <code>ReplicationController</code>, porém não irá adotar <code>Pods</code> que não respeitem a definição de seu template, de modo que caso encontre <code>Pods</code> orfãs que não coincidam com a sua definição irá destruí-los e criar novos que estejam conforme o contrato. Quando a definição de um <code>Deployment</code> é alterada ele irá verificar se os <code>Pods</code> ainda respeitam essa nova definição, caso não respeitem ele irá destruí-los e criar novos <code>Pods</code> conforme seu contrato. Também mantém um histórico das suas definições, de modo que o usuário pode facilmente retornar a um estado anterior (<code>rollout</code>).</li>
<li><strong>ReplicaSet</strong>: é muito semelhante ao <code>ReplicationController</code>, porém permite usar regras de <code>selector</code> mais completas e pode utilizar a função &ldquo;<code>rolling-update</code>&rdquo; que irá verificar a definição dos <code>Pods</code> no <code>selector</code> e atualizá-los um a um de forma semelhante ao <code>Deployment</code>. Em verdade o <code>Deployment</code> usa <code>ReplicaSets</code> para atualizar o Pods, sendo os itens do seu histórico os <code>ReplicaSets</code> já utilizados.</li>
<li><strong>StatefulSet</strong>: representa <code>Controllers</code> que devem gerar <code>Pods</code> com caracteristicas persistentes, ou que a ordem de criação tenha influência. Quando eles são criados é possível definir um template de <code>Persistent Volume Claims</code> que serão criados para cada um dos nós, de modo que quando os mesmos voltam a ativa podem retormar seus estados no momento que sairam do ar. (acho que pode ser útil para construir <code>Pods</code> para nós de bancos de dados que funcionam por replicação).</li>
<li><strong>DaemonSet</strong>: é um <code>Controller</code> que garante que um certo tipo de <code>Pod</code> será adicionado a todos os nós do cluster. Os <code>Pods</code> que são criados por ele normalmente são do tipo de coleta de logs (<code>fluentd</code>, <code>logstash</code>), monitores (<code>New Relic</code>, <code>Prometheus Exporter</code>) e serviços semelhantes.</li>
<li><strong>Job</strong>: é um <code>Controller</code> para executar <code>Pods</code> de vida curta, no sentido de pequenos comandos ou execuções que não precisam ser servidas. Normalmente são criados por <code>Cron Jobs</code> do K8s.</li>
</ul>
<h2 id=services>
Services
<a href=#services class=heading-anchor><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" xmlns:xlink="http://www.w3.org/1999/xlink" enable-background="new 0 0 512 512"><g><g><g><path d="M480.7 11H130.4c-11.3.0-20.4 9.1-20.4 20.4v60.3H31.5c-11.3.0-20.4 9.1-20.4 20.4v368.5c0 11.3 9.1 20.4 20.4 20.4h350.3c11.3.0 20.4-9.1 20.4-20.4v-60.3h78.5c11.3.0 20.4-9.1 20.4-20.4V31.4C501.1 20.1 491.9 11 480.7 11zM361.3 460.2H51.9V132.5h309.4V460.2zm98.9-80.7h-58.1V112.1c0-11.3-9.1-20.4-20.4-20.4h-231V51.8h309.4V379.5z"/><path d="m127.8 242.6h157.7c11.3.0 20.4-9.1 20.4-20.4s-9.1-20.4-20.4-20.4H127.8c-11.3.0-20.4 9.1-20.4 20.4s9.1 20.4 20.4 20.4z"/><path d="m127.8 390.9h157.7c11.3.0 20.4-9.1 20.4-20.4.0-11.3-9.1-20.4-20.4-20.4H127.8c-11.3.0-20.4 9.1-20.4 20.4.0 11.2 9.1 20.4 20.4 20.4z"/></g></g></g></svg>
</a>
</h2>
<p>Como os <code>Pods</code> além de efêmeros, podem existir em números variados por culpa dos <code>Controllers</code>, não há forma confiável de tentar conectar dois <code>Pods</code> diretamente, seja porque o <code>Pod</code> que você está dependendo pode morrer e quando voltar terá outro IP, e provavelmente outro nome, ou porque o <code>Pod</code> que você &ldquo;fixou&rdquo; pode não ser o mas indicado (menos ocupado ou mais próximo).</p>
<p>Para resolver esse problema existem os <code>Services</code>, em vez de tentar fazer as chamadas diretamente para um <code>Pod</code>, podemos chamar pelo nome de um <code>Service</code> e este irá rotear para um <code>Pod</code> que esteja abaixo dele.</p>
<p>Os <code>Services</code> também são a forma padrão para se expor serviços do cluster para o mundo exterior.</p>
<h2 id=arquitetura>
Arquitetura
<a href=#arquitetura class=heading-anchor><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" xmlns:xlink="http://www.w3.org/1999/xlink" enable-background="new 0 0 512 512"><g><g><g><path d="M480.7 11H130.4c-11.3.0-20.4 9.1-20.4 20.4v60.3H31.5c-11.3.0-20.4 9.1-20.4 20.4v368.5c0 11.3 9.1 20.4 20.4 20.4h350.3c11.3.0 20.4-9.1 20.4-20.4v-60.3h78.5c11.3.0 20.4-9.1 20.4-20.4V31.4C501.1 20.1 491.9 11 480.7 11zM361.3 460.2H51.9V132.5h309.4V460.2zm98.9-80.7h-58.1V112.1c0-11.3-9.1-20.4-20.4-20.4h-231V51.8h309.4V379.5z"/><path d="m127.8 242.6h157.7c11.3.0 20.4-9.1 20.4-20.4s-9.1-20.4-20.4-20.4H127.8c-11.3.0-20.4 9.1-20.4 20.4s9.1 20.4 20.4 20.4z"/><path d="m127.8 390.9h157.7c11.3.0 20.4-9.1 20.4-20.4.0-11.3-9.1-20.4-20.4-20.4H127.8c-11.3.0-20.4 9.1-20.4 20.4.0 11.2 9.1 20.4 20.4 20.4z"/></g></g></g></svg>
</a>
</h2>
<figure class=big>
<img class="lazyload blur-up" loading=lazy data-src=https://upload.wikimedia.org/wikipedia/commons/b/be/Kubernetes.png>
<figcaption><p>arquitetura do kubernetes</p></figcaption>
</figure>
</div><section class=share>
<p>
Share this gist at
<a href="https://twitter.com/share?text=Notas%20Kubernetes%20-%20Coderockr%20Jam%202017-03-11&nbsp;-&nbsp;Lucas%20dos%20Santos%20Abreu&url=http%3a%2f%2fwww.lucassabreu.net.br%2fpreview%2f6%2fgist%2fcoderockr-jam-2017-03%2f" onclick="return window.open(this.href,'twitter-share','width=550,height=235'),!1">
Twitter
</a>
<a href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2fwww.lucassabreu.net.br%2fpreview%2f6%2fgist%2fcoderockr-jam-2017-03%2f" onclick="return window.open(this.href,'facebook-share','width=580,height=296'),!1">
Facebook
</a>
<a href="http://pinterest.com/pin/create/button/?url=http%3a%2f%2fwww.lucassabreu.net.br%2fpreview%2f6%2fgist%2fcoderockr-jam-2017-03%2f&description=Notas%20Kubernetes%20-%20Coderockr%20Jam%202017-03-11" onclick="return window.open(this.href,'pinterest-share','width=580,height=296'),!1">
Pinterest
</a>
</p>
</section>
<footer>
<section role=comment>
<p>
<div id=disqus_thread></div>
<script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//lucas-dos-santos-abreu.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script>
<noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript>
<a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a>
</p>
</section>
<section>
<p>
Published
by <span itemprop=author></span>
<time datetime=2017-03-11T00:00:00+00:00>
11 Mar, 2017
</time>
and tagged
<a href=/preview/6/tags/coderockr-jam>Coderockr Jam</a>
<a href=/preview/6/tags/kubernetes>Kubernetes</a>
<a href=/preview/6/tags/basics>Basics</a>
using <span itemprop=wordCount>1004</span> words.
</p>
</section>
</footer>
</article>
</main>
<aside>
<header>Related Content</header>
<ul>
<li>
<a href=/preview/6/post/um-ambiente-simples-usando-kubernetes-e-openshift-next-gen-parte-4/>Um ambiente simples usando Kubernetes e OpenShift Next Gen - Parte 4</a> &ndash;
<time>4 minute read</time>
</li>
<li>
<a href=/preview/6/post/um-ambiente-simples-usando-kubernetes-e-openshift-next-gen-parte-3/>Um ambiente simples usando Kubernetes e OpenShift Next Gen - Parte 3</a> &ndash;
<time>4 minute read</time>
</li>
<li>
<a href=/preview/6/post/um-ambiente-simples-usando-kubernetes-e-openshift-next-gen-parte-2/>Um ambiente simples usando Kubernetes e OpenShift Next Gen - Parte 2</a> &ndash;
<time>5 minute read</time>
</li>
<li>
<a href=/preview/6/post/um-ambiente-simples-usando-kubernetes-e-openshift-next-gen-parte-1/>Um ambiente simples usando Kubernetes e OpenShift Next Gen - Parte 1</a> &ndash;
<time>4 minute read</time>
</li>
</ul>
</aside>
<footer>
<p>
&copy;
2021 ·
This page was generated using <a target=_blank rel=noopener href=https://github.com/colorchestra/smol>smol<a> for <a target=_blank rel=noopener href=https://gohugo.io/>Hugo</a>.
</p>
</footer>
</body>
</html>