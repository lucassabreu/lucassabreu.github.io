<!doctype html><html lang=pt-br>
<head>
<meta itemprop=name content="Github Actions">
<meta itemprop=description content="O que √© isso? ¬∂ O Github Actions √© primariamente uma ferramenta para implementar Continuous Integration, ou seja, automatizar a execu√ß√£o de ferramentas ou processos que ajudam a garantir a qualidade do c√≥digo, seja teste unit√°rios, an√°lises de c√≥digo est√°tica, analises de seguran√ßa, simplesmente compilar/&ldquo;buildar&rdquo; o projeto.
Al√©m disso tamb√©m podemos implementar fluxos de Continuous Delivery, fazendo o deploy ou bundle do projeto de forma autom√°tica sempre que um evento acontece, seja o push para uma branch, ou algum outro evento do Github."><meta itemprop=datePublished content="2021-09-12T00:00:00+00:00">
<meta itemprop=dateModified content="2021-09-12T00:00:00+00:00">
<meta itemprop=wordCount content="3033">
<meta itemprop=keywords content="Github,Github Actions,Continuous Integration,">
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta http-equiv=x-ua-compatible content="IE=edge">
<style type=text/css>body{font-family:monospace}</style>
<title>
Github Actions |
Lucas dos Santos Abreu
</title>
<link rel=stylesheet href="/preview/6/css/style.css?rnd=1633486423">
<script src="/preview/6/js/index.js?rnd=1633486423"></script>
</head>
<body>
<a class=skip-to-content-link href=#main> Skip to content </a>
<header class=page-header>
<nav arial-label=primary role=menu>
<a href=/preview/6/preview/6/>Home</a>
<a href=/preview/6/preview/6/resume>Resume</a>
<a href=https://twitter.com/LucasSantAbreu>Twitter</a>
<a href=https://github.com/lucassabreu>GitHub</a>
<a href=https://medium.com/@lucassabreu>Medium</a>
<a href=https://www.linkedin.com/in/lucassantosabreu>LinkedIn</a>
</nav>
</header>
<main id=main>
<article>
<header>
<h1>Github Actions</h1>
<p>
<span class=reading-time>15 minute read</span>
<span class=published-at>
Published:
<time datetime="2021-09-12 00:00:00 +0000 UTC">2021-09-12</time>
</span>
</p>
</header>
<nav role=navigation class=toc><strong>TOC</strong>
<ol>
<li><a href=#o-que-√©-isso>O que √© isso?</a></li>
<li><a href=#como-temos-usado-o-github-actionsci-em-geral>Como temos usado o Github Actions/CI em geral</a></li>
<li><a href=#show-me-the-code>Show me the code</a>
<ol>
<li><a href=#workflow-simples>Workflow simples</a></li>
<li><a href=#lintsanalise-est√°tica-com-annotations>Lints/Analise Est√°tica com annotations</a></li>
</ol>
</li>
<li><a href=#integra√ß√µes-e-actions>Integra√ß√µes e &ldquo;Actions&rdquo;</a>
<ol>
<li><a href=#docker-steps>Docker Steps</a></li>
<li><a href=#secrets>Secrets</a></li>
</ol>
</li>
<li><a href=#outros-eventos-e-usos>Outros eventos e usos</a>
<ol>
<li><a href=#cron-schedule>CRON (<code>schedule</code>)</a></li>
<li><a href=#pull-request-labels-labelled>Pull Request Labels (<code>labelled</code>)</a></li>
<li><a href=#coment√°rios-issue_comment>Coment√°rios (<code>issue_comment</code>)</a></li>
<li><a href=#manual-workflow_dispatch-e-repository_dispatch>Manual (<code>workflow_dispatch</code> e <code>repository_dispatch</code>)</a></li>
</ol>
</li>
<li><a href=#criar-actions>Criar Actions</a></li>
</ol>
</nav>
<div class=content role=content>
<h2 id=o-que-√©-isso>O que √© isso? <a href=#o-que-%c3%a9-isso class=heading-anchor>¬∂</a></h2>
<p>O Github Actions √© primariamente uma ferramenta para implementar Continuous
Integration, ou seja, automatizar a execu√ß√£o de ferramentas ou processos que
ajudam a garantir a qualidade do c√≥digo, seja teste unit√°rios, an√°lises de
c√≥digo est√°tica, analises de seguran√ßa, simplesmente compilar/&ldquo;buildar&rdquo; o
projeto.</p>
<p>Al√©m disso tamb√©m podemos implementar fluxos de Continuous Delivery, fazendo o
deploy ou bundle do projeto de forma autom√°tica sempre que um evento acontece,
seja o <code>push</code> para uma branch, ou algum outro evento do Github.</p>
<p>A grande maioria das ferramentas de CI permite fazer esses tipos de
controles/processos, mas o interessante do Github Actions √© que ele esta integrado
com o sistema de eventos (webhooks) e com a API do Github, ent√£o quando voc√™
quer usar funcionalidades do Github com os <a href=oi>commit status</a>,
<a href=oi>deployment status</a>, <a href=https://docs.github.com/en/github/collaborating-with-pull-requests/collaborating-on-repositories-with-code-quality-features/about-status-checks#checks>checks/annotations</a> o processo √© bem simples.</p>
<h2 id=como-temos-usado-o-github-actionsci-em-geral>Como temos usado o Github Actions/CI em geral <a href=#como-temos-usado-o-github-actionsci-em-geral class=heading-anchor>¬∂</a></h2>
<p>Para a maioria dos projetos da <a href=https://coderockr.com>Coderockr</a> n√≥s sempre adicionamos algumas
ferramentas para CI, que s√£o executadas em todos os PRs e a maioria no <code>push</code>
para branchs &ldquo;principais&rdquo; (<code>main</code>, <code>develop</code>, <code>release</code>, etc).</p>
<p>Essas ferramentas s√£o fazem lint, analise est√°tica e testes unit√°rios, todas
elas s√£o &ldquo;script√°veis&rdquo; e configur√°veis, ent√£o podemos simplesmente com um shell
script simples podemos executar elas, capturar os arquivos com problema (as
vezes detalhando a linha espec√≠fica) e notificar o desenvolvedor sobre os
problemas e bloquear o merge/deploy baseado nelas.</p>
<h2 id=show-me-the-code>Show me the code <a href=#show-me-the-code class=heading-anchor>¬∂</a></h2>
<p>Mas beleza, n√≥s temos as ferramentas, como integrar elas no Github Actions?
Para isso temos de criar um <code>workflow</code>, que √© o termo que o Github usa para
representar uma sequencia de etapas que √© executada em resposta a um evento no
reposit√≥rio ou API (<a href=#dispatch>voltamos nisso depois</a>).</p>
<dl>
<dt>üí° Todos os exemplos que vou mostrar podem ser vistos nesse reposit√≥rio:</dt>
<dd><a href=https://github.com/lucassabreu/github-actions-examples>lucassabreu/github-actions-examples</a></dd>
</dl>
<h3 id=workflow-simples>Workflow simples <a href=#workflow-simples class=heading-anchor>¬∂</a></h3>
<p>Para criar o <code>workflow</code> basta fazer o commit de um arquivo <code>yaml</code> dentro da pasta
<code>.github/workflows</code>, e automaticamente o Github ir√° utilizar ele assim que o
evento que voc√™ definiu acontecer com a branch que estiver (alguns eventos s√≥
v√£o funcionar se o <code>workflow</code> estiver na branch default).</p>
<p>Um exemplo simples que temos em alguns projetos √© esse:</p>
<div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#495050"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">25
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#268bd2>name</span>: <span style=color:#2aa198>&#34;PHPUnit&#34;</span>
<span style=color:#268bd2>on</span>:
  <span style=color:#268bd2>pull_request</span>:
  <span style=color:#268bd2>push</span>:
    <span style=color:#268bd2>branches</span>: [main]

<span style=color:#268bd2>jobs</span>:
  <span style=color:#268bd2>php-tests</span>:
    <span style=color:#268bd2>runs-on</span>: ubuntu-latest

    <span style=color:#268bd2>steps</span>:
      - <span style=color:#268bd2>name</span>: Checkout code
        <span style=color:#268bd2>uses</span>: actions/checkout@v2

      - <span style=color:#268bd2>name</span>: Setup PHP
        <span style=color:#268bd2>uses</span>: shivammathur/setup-php@v2
        <span style=color:#268bd2>with</span>:
          <span style=color:#268bd2>php-version</span>: <span style=color:#2aa198>8.0</span>
          <span style=color:#268bd2>tools</span>: composer:v2

      - <span style=color:#268bd2>name</span>: Install dependencies
        <span style=color:#268bd2>run</span>: composer install --prefer-dist

      - <span style=color:#268bd2>name</span>: Execute Unit Tests
        <span style=color:#268bd2>run</span>: php vendor/bin/phpunit
</code></pre></td></tr></table>
</div>
</div><p class=code-legend>.github/workflows/phpunit.yaml</p>
<p>Esse √© o tipo mais simples de <code>workflow</code> que pode ser feito no Github Actions,
apenas executa a cada push para a <code>main</code> e em todos os <code>pull requests</code>, e a
√∫nica sa√≠da gerada √© o &ldquo;commit status&rdquo;.</p>
<p>
<figure class=big>
<img class="lazyload blur-up" loading=lazy data-src=phpunit-basic-checks.png alt="commit status" width=944 height=223>
<figcaption><p>commit status gerados pelo workflow</p></figcaption>
</figure>
</p>
<p>Mas com isso j√° poss√≠vel bloquear <code>pull requests</code> que n√£o atendem a qualidade
esperada, ou que quebrem algo no caso do PHPUnit; para todos os
desenvolvedores do projeto o acesso a porqu√™ o commit n√£o passou esta a um
click.</p>
<p>
<figure class=big>
<img class="lazyload blur-up" loading=lazy data-src=./github-actions-check-details.png alt="check details">
<figcaption><p>logs do phpunit no github actions</p></figcaption>
</figure>
</p>
<h3 id=lintsanalise-est√°tica-com-annotations>Lints/Analise Est√°tica com annotations <a href=#lintsanalise-est%c3%a1tica-com-annotations class=heading-anchor>¬∂</a></h3>
<p>Mas esse √© s√≥ o b√°sico podemos fazer algumas coisas mais avan√ßadas com o Github
Actions e a integra√ß√£o &ldquo;auto-m√°gica&rdquo; com a API do Github.</p>
<p>Uma integra√ß√£o que precisava de um setup grande para fazer, mas que era muito boa
para auxiliar no revis√£o autom√°tica s√£o os <a href=https://docs.github.com/en/github/collaborating-with-pull-requests/collaborating-on-repositories-with-code-quality-features/about-status-checks#checks>annotations</a>. Com eles podemos
criar &ldquo;coment√°rios&rdquo; diretamente nos arquivos do PR/reposit√≥rio de forma
automatizada, marcando inclusive qual a linha que tem o problema e qual o
problema daquela linha.</p>
<p>
<figure class=big>
<img class="lazyload blur-up" loading=lazy data-src=./phpstan-github-annotation.png alt="phpstan github annotations">
<figcaption><p>exemplo de annotations</p></figcaption>
</figure>
</p>
<p>A utilidade disso √© que agora quando o time for revisar o PR podemos focar no
design da solu√ß√£o e na regra de neg√≥cio que esta sendo implementada, no lugar de
revisar se o fonte possui problemas estruturais ou erros de
compila√ß√£o/interpreta√ß√£o que possam acontecer.</p>
<p>Isso √© claro depende do ferramental que a linguagem que voc√™ esta trabalhando
oferece, no caso do PHP quase todos os nossos projetos v√£o incluir o
<a href=wip>PHPStan</a> (ou <a href=wip>Phan</a>), <a href=wip>PHPMD</a>, <a href=wip>PHPCS</a> e <a href=wip>PHP CS Fixer</a> para
padronizar e analisar o c√≥digo.</p>
<p>O exemplo da imagem anterior √© feita com o seguinte <code>workflow</code>:</p>
<div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#495050"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">28
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#268bd2>name</span>: <span style=color:#2aa198>&#34;PHPStan&#34;</span>
<span style=color:#268bd2>on</span>:
  <span style=color:#268bd2>pull_request</span>:
  <span style=color:#268bd2>push</span>:
    <span style=color:#268bd2>branches</span>: [main]

<span style=color:#268bd2>jobs</span>:
  <span style=color:#268bd2>php-stan</span>:
    <span style=color:#268bd2>runs-on</span>: ubuntu-latest
    <span style=color:#268bd2>timeout-minutes</span>: <span style=color:#2aa198>15</span>
    <span style=color:#268bd2>env</span>:
      <span style=color:#268bd2>COMPOSER_NO_INTERACTION</span>: <span style=color:#2aa198>1</span>

    <span style=color:#268bd2>steps</span>:
      - <span style=color:#268bd2>name</span>: Checkout code
        <span style=color:#268bd2>uses</span>: actions/checkout@v2

      - <span style=color:#268bd2>name</span>: Setup PHP
        <span style=color:#268bd2>uses</span>: shivammathur/setup-php@v2
        <span style=color:#268bd2>with</span>:
          <span style=color:#268bd2>php-version</span>: <span style=color:#2aa198>8.0</span>
          <span style=color:#268bd2>tools</span>: composer:v2

      - <span style=color:#268bd2>name</span>: Install dependencies
        <span style=color:#268bd2>run</span>: composer install --prefer-dist

      - <span style=color:#268bd2>name</span>: Execute PHPStan
        <span style=color:#268bd2>run</span>: php vendor/bin/phpstan analyse src --level 8 --error-format=github
</code></pre></td></tr></table>
</div>
</div><p class=code-legend>exemplo de workflow com phpstan</p>
<p>O mesmo √© basicamente igual ao <code>workflow</code> criado para o PHPUnit antes, apenas
chamando o PHPStan dessa vez, e com isso ele j√° gera as <code>annotations</code>, isso
porque o Actions tem um conceito de &ldquo;<a href=https://docs.github.com/en/actions/reference/workflow-commands-for-github-actions>workflow message commands</a>&rdquo;.</p>
<p>Ele interpreta a sa√≠da do <code>workflow</code> e se a linha repeitar um dos formatos
abaixo, ele destaca essa informa√ß√£o.</p>
<pre><code>::notice file={name},line={line},endLine={endLine},title={title}::{message}
::warning file={name},line={line},endLine={endLine},title={title}::{message}
::error file={name},line={line},endLine={endLine},title={title}::{message}
</code></pre><p>Quando o Actios identifica um desses formatos no output do <code>workflow</code> ele
automaticamente cria um <code>annotation</code> com o mesmo &ldquo;n√≠vel&rdquo; no <code>pull request</code> (se
existir um para a execu√ß√£o).</p>
<p>Ent√£o se eu criar um <code>step</code> como o abaixo:</p>
<div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#495050">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">26
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>    - <span style=color:#268bd2>name</span>: Fake
      <span style=color:#268bd2>run</span>: |<span style=color:#2aa198>
</span><span style=color:#2aa198>        echo ::notice \
</span><span style=color:#2aa198>          file=$PWD/src/Hugger/Friendly.php,line=1,col=0::this is a notice
</span><span style=color:#2aa198>        echo ::warning \
</span><span style=color:#2aa198>          file=$PWD/src/Hugger/Friendly.php,line=1,col=0::this is a warning
</span><span style=color:#2aa198>        echo ::error \
</span><span style=color:#2aa198>          file=$PWD/src/Hugger/Friendly.php,line=1,col=0::this is a error</span>        

</code></pre></td></tr></table>
</div>
</div><p>Vai gerar uma nova <code>annotation</code>:</p>
<p>
<figure class=big>
<img class="lazyload blur-up" loading=lazy data-src=./fake-annotations.png alt="fake annotation">
</figure>
</p>
<p>Isso mostra qu√£o f√°cil √© integrar com essa funcionalidade do Github Actions,
v√°rias ferramentas tem formatos de sa√≠da prontos para integrar com ele, e as
que n√£o tem, bem est√£o a um <a href=https://github.com/lucassabreu/github-actions-examples/blob/f051cee06d489998f90e4e4cb6fc71afcc5fc7ca/.github/workflows/phpcs.yaml#L35-L38><code>sed</code></a> de dist√¢ncia.</p>
<h2 id=integra√ß√µes-e-actions>Integra√ß√µes e &ldquo;Actions&rdquo; <a href=#integra%c3%a7%c3%b5es-e-actions class=heading-anchor>¬∂</a></h2>
<p>Para a maioria das ferramentas, principalmente para as que pode/devem ser
executadas como parte do <code>pre-commit</code> usar o <code>step.run</code> √© a melhor forma,
f√°cil de entender e inclusive j√° mostra como executar localmente assim o
desenvolvedor n√£o precisa fazer o push para ver os resultados, ele pode apenas
rodar o <code>php vendor/bin/phpunit</code> no terminal antes de fazer o commit e feito.</p>
<p>Mas existem algumas etapas que podemos adicionar no <code>workflow</code> que n√£o precisam
(talvez n√£o devam) ser executadas localmente, por exemplo: deploys, cache de
arquivos, relat√≥rios de cobertura, integra√ß√µes com servi√ßos externos, setup de
ferramentas para usar, etc.</p>
<p>Um exemplo simples √© uma etapa para enviar o relat√≥rio de cobertura para o
<a href=wip>Codecov</a>:</p>
<div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#495050">35
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">36
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">37
</span><span style=display:block;width:100%;background-color:#19404a><span style="margin-right:.4em;padding:0 .4em;color:#495050">38
</span></span><span style=display:block;width:100%;background-color:#19404a><span style="margin-right:.4em;padding:0 .4em;color:#495050">39
</span></span><span style=display:block;width:100%;background-color:#19404a><span style="margin-right:.4em;padding:0 .4em;color:#495050">40
</span></span><span style=display:block;width:100%;background-color:#19404a><span style="margin-right:.4em;padding:0 .4em;color:#495050">41
</span></span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>      - <span style=color:#268bd2>name</span>: Execute Unit Tests
        <span style=color:#268bd2>run</span>: phpdbg -qrr vendor/bin/phpunit --coverage-clover=clover.xml

<span style=display:block;width:100%;background-color:#19404a>      - <span style=color:#268bd2>name</span>: Upload coverage to Codecov
</span><span style=display:block;width:100%;background-color:#19404a>        <span style=color:#268bd2>uses</span>: codecov/codecov-action@v2
</span><span style=display:block;width:100%;background-color:#19404a>        <span style=color:#268bd2>with</span>:
</span><span style=display:block;width:100%;background-color:#19404a>          <span style=color:#268bd2>files</span>: ./clover.xml
</span></code></pre></td></tr></table>
</div>
</div><p>A etapa <code>Upload coverage to Codecov</code> usa uma <code>action</code> chamada
<a href=https://github.com/marketplace/actions/codecov><code>codecov/codecov-action</code></a>, <code>actions</code> s√£o o que d√£o o nome para a
plataforma, e s√£o plugins que podem ser adicionados aos <code>workflows</code> que
resolvem algum problema espec√≠fico, que podem ser os problemas que listei antes
ou &ldquo;receitas prontas&rdquo; para alguma ferramenta.</p>
<p>Diferente dos exemplos anteriores n√£o passamos um script para ser executado na
etapa, mas sim qual o nome da <code>action</code> com o <code>uses</code> e (dependendo da <code>action</code>)
par√¢metros complementares que ela possa receber.</p>
<p>O Github tem um marketplace para eles que voc√™ pode usar tanto para publicar os
seus pr√≥prios, quanto para procurar solu√ß√µes prontas (por mais que o Google
tenha sido melhor para pesquisar, mas a pagina no marketplace ajuda o Google
pelo menos).</p>
<p>
<figure class=big>
<img class="lazyload blur-up" loading=lazy data-src=./github-marketplace.png alt=marketplace>
<figcaption><p>marketplace com alguns actions para php</p></figcaption>
</figure>
</p>
<p>E podemos encontrar todo tipo de <code>action</code> pronta para ser adicionada aos
<code>workflows</code>, no meu blog eu n√£o precisei escrever l√≥gica para instalar o <code>hugo</code>
ou para &ldquo;buildar&rdquo; e fazer push dele para a branch <code>gh-pages</code>, isso tudo √© feito
por <code>actions</code> que outras pessoas escreveram.</p>
<div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#495050"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">16
</span><span style=display:block;width:100%;background-color:#19404a><span style="margin-right:.4em;padding:0 .4em;color:#495050">17
</span></span><span style=display:block;width:100%;background-color:#19404a><span style="margin-right:.4em;padding:0 .4em;color:#495050">18
</span></span><span style=display:block;width:100%;background-color:#19404a><span style="margin-right:.4em;padding:0 .4em;color:#495050">19
</span></span><span style=display:block;width:100%;background-color:#19404a><span style="margin-right:.4em;padding:0 .4em;color:#495050">20
</span></span><span style="margin-right:.4em;padding:0 .4em;color:#495050">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">24
</span><span style=display:block;width:100%;background-color:#19404a><span style="margin-right:.4em;padding:0 .4em;color:#495050">25
</span></span><span style=display:block;width:100%;background-color:#19404a><span style="margin-right:.4em;padding:0 .4em;color:#495050">26
</span></span><span style=display:block;width:100%;background-color:#19404a><span style="margin-right:.4em;padding:0 .4em;color:#495050">27
</span></span><span style=display:block;width:100%;background-color:#19404a><span style="margin-right:.4em;padding:0 .4em;color:#495050">28
</span></span><span style=display:block;width:100%;background-color:#19404a><span style="margin-right:.4em;padding:0 .4em;color:#495050">29
</span></span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=color:#268bd2>name</span>: GH Pages
<span style=color:#268bd2>on</span>:
  <span style=color:#268bd2>push</span>:
    <span style=color:#268bd2>branches</span>:
      - main

<span style=color:#268bd2>jobs</span>:
  <span style=color:#268bd2>build-and-deploy</span>:
    <span style=color:#268bd2>runs-on</span>: ubuntu-latest
    <span style=color:#268bd2>steps</span>:
      - <span style=color:#268bd2>name</span>: Checkout üõéÔ∏è
        <span style=color:#268bd2>uses</span>: actions/checkout@v2.3.1
        <span style=color:#268bd2>with</span>:
          <span style=color:#268bd2>submodules</span>: <span style=color:#cb4b16>true</span>
          <span style=color:#268bd2>fetch-depth</span>: <span style=color:#2aa198>0</span>

<span style=display:block;width:100%;background-color:#19404a>      - <span style=color:#268bd2>name</span>: Setup Hugo
</span><span style=display:block;width:100%;background-color:#19404a>        <span style=color:#268bd2>uses</span>: peaceiris/actions-hugo@v2
</span><span style=display:block;width:100%;background-color:#19404a>        <span style=color:#268bd2>with</span>:
</span><span style=display:block;width:100%;background-color:#19404a>          <span style=color:#268bd2>hugo-version</span>: <span style=color:#2aa198>&#34;0.87.0&#34;</span>
</span>
      - <span style=color:#268bd2>name</span>: Build
        <span style=color:#268bd2>run</span>: hugo -v --minify -b http://www.lucassabreu.net.br

<span style=display:block;width:100%;background-color:#19404a>      - <span style=color:#268bd2>name</span>: Deploy üöÄ
</span><span style=display:block;width:100%;background-color:#19404a>        <span style=color:#268bd2>uses</span>: JamesIves/github-pages-deploy-action@4.1.5
</span><span style=display:block;width:100%;background-color:#19404a>        <span style=color:#268bd2>with</span>:
</span><span style=display:block;width:100%;background-color:#19404a>          <span style=color:#268bd2>branch</span>: gh-pages
</span><span style=display:block;width:100%;background-color:#19404a>          <span style=color:#268bd2>folder</span>: public
</span></code></pre></td></tr></table>
</div>
</div><p class=code-legend>.github/workflows/gh-pages.yaml</p>
<p>Existe uma grande variedade desses tipos de <code>actions</code> que fazem o setup para
uma ferramenta, ou que interagem com o Github ou outros servi√ßos de forma
simplificada.</p>
<h3 id=docker-steps>Docker Steps <a href=#docker-steps class=heading-anchor>¬∂</a></h3>
<p>N√≥s usamos o Docker para o desenvolvimento local e em produ√ß√£o para a maioria
dos projetos para manter os ambientes o mais pr√≥ximos poss√≠vel. E no <a href=wip>Drone
CI</a> e <a href=wip>Buildkite</a> usamos as mesmas imagens (ou bem pr√≥ximas) para executar
as ferramentas de analise est√°tica e testes unit√°rios, porque se estamos usando
uma imagem customizada √© prov√°vel que eles falhem por n√£o ter a referencia a
alguma fun√ß√£o ou classe.</p>
<p>Nesse sentido no lugar de usar uma <code>action</code> para instalar a linguagem e ainda
adicionar extens√µes ou customiza√ß√µes do ambiente, por mais que poss√≠vel, acaba
sendo um trabalho duplicado, e sempre temos de lembrar de atualizar a imagem
base e o <code>workflow</code> toda vez, ent√£o quando isso acontece n√≥s usamos imagens do
Docker como etapas para rodar as opera√ß√µes.</p>
<p>Usando uma imagem do Docker no n√≠vel do <code>runs-on</code> adicionamos qual o cont√™iner
a ser usado:</p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff>name: &#34;PHPUnit (with Docker)&#34;
on:
  pull_request:
  push:
    branches: [main]

jobs:
  php-tests:
    runs-on: ubuntu-latest
<span style=color:#719e07>+    container:
</span><span style=color:#719e07>+      image: ghcr.io/lucassabreu/php-with-exts-example:main
</span><span style=color:#719e07>+      options: --user root
</span><span style=color:#719e07></span>
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

<span style=color:#dc322f>-      - name: Setup PHP
</span><span style=color:#dc322f>-        uses: shivammathur/setup-php@v2
</span><span style=color:#dc322f>-        with:
</span><span style=color:#dc322f>-          php-version: 8.0
</span><span style=color:#dc322f>-          tools: composer:v2
</span><span style=color:#dc322f></span>
      - name: Install dependencies
        run: composer install --prefer-dist

      - name: Execute Unit Tests
        run: phpdbg -qrr vendor/bin/phpunit --coverage-clover=clover.xml

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v2
        with:
          files: ./clover.xml
</code></pre></div><p class=code-legend>exemplo usando docker</p>
<p>A imagem desse exemplo √© orientada para ser usada fora do Github tamb√©m,
ent√£o eu tive de adicionar o <code>--user root</code>, porque alguns <code>actions</code> precisam
instalar pacotes (o <code>actions/checkout@v2</code> instala o <code>git</code> e outras coisas).</p>
<p>Mas essa n√£o √© a √∫nica forma de usar o imagens do Docker se voc√™ ou a
ferramenta que voc√™ normalmente usa tiver uma imagem para ser usada, ent√£o pode
adicionar a mesma como um <code>step</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#268bd2>name</span>: <span style=color:#2aa198>&#34;PHPInsights&#34;</span>
<span style=color:#268bd2>on</span>:
  <span style=color:#268bd2>pull_request</span>:
  <span style=color:#268bd2>push</span>:
    <span style=color:#268bd2>branches</span>: [main]

<span style=color:#268bd2>jobs</span>:
  <span style=color:#268bd2>check</span>:
    <span style=color:#268bd2>runs-on</span>: ubuntu-latest

    <span style=color:#268bd2>steps</span>:
      - <span style=color:#268bd2>name</span>: Checkout code
        <span style=color:#268bd2>uses</span>: actions/checkout@v2

      - <span style=color:#268bd2>name</span>: PHPInsights
        <span style=color:#268bd2>uses</span>: docker://nunomaduro/phpinsights
        <span style=color:#268bd2>with</span>:
          <span style=color:#268bd2>args</span>: --format=github-action
</code></pre></div><p class=code-legend>docker como um `step`</p>
<p>Se ela tiver um formato de sa√≠da compat√≠vel com os <a href=#lintsanalise-est%C3%A1tica-com-annotations>annotations commands</a>
ent√£o fica parecendo que √© uma <code>action</code> nativa.</p>
<p>Podemos ainda executar Docker in Docker se for necess√°rio combinar a sua imagem
pr√≥pria e usar outra imagem como um <code>step</code>.</p>
<div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#495050"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050"> 9
</span><span style=display:block;width:100%;background-color:#19404a><span style="margin-right:.4em;padding:0 .4em;color:#495050">10
</span></span><span style=display:block;width:100%;background-color:#19404a><span style="margin-right:.4em;padding:0 .4em;color:#495050">11
</span></span><span style=display:block;width:100%;background-color:#19404a><span style="margin-right:.4em;padding:0 .4em;color:#495050">12
</span></span><span style="margin-right:.4em;padding:0 .4em;color:#495050">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">20
</span><span style=display:block;width:100%;background-color:#19404a><span style="margin-right:.4em;padding:0 .4em;color:#495050">21
</span></span><span style=display:block;width:100%;background-color:#19404a><span style="margin-right:.4em;padding:0 .4em;color:#495050">22
</span></span><span style=display:block;width:100%;background-color:#19404a><span style="margin-right:.4em;padding:0 .4em;color:#495050">23
</span></span><span style=display:block;width:100%;background-color:#19404a><span style="margin-right:.4em;padding:0 .4em;color:#495050">24
</span></span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#268bd2>name</span>: <span style=color:#2aa198>&#34;PHPCS (Docker in Docker)&#34;</span>
<span style=color:#268bd2>on</span>:
  <span style=color:#268bd2>pull_request</span>:
  <span style=color:#268bd2>push</span>:
    <span style=color:#268bd2>branches</span>: [main]

<span style=color:#268bd2>jobs</span>:
  <span style=color:#268bd2>check</span>:
    <span style=color:#268bd2>runs-on</span>: ubuntu-latest
<span style=display:block;width:100%;background-color:#19404a>    <span style=color:#268bd2>container</span>:
</span><span style=display:block;width:100%;background-color:#19404a>      <span style=color:#268bd2>image</span>: ghcr.io/lucassabreu/php-with-exts-example:main
</span><span style=display:block;width:100%;background-color:#19404a>      <span style=color:#268bd2>options</span>: --user root
</span>
    <span style=color:#268bd2>steps</span>:
      - <span style=color:#268bd2>name</span>: Checkout code
        <span style=color:#268bd2>uses</span>: actions/checkout@v2

      - <span style=color:#268bd2>name</span>: Install dependencies
        <span style=color:#268bd2>run</span>: composer install --prefer-dist

<span style=display:block;width:100%;background-color:#19404a>      - <span style=color:#268bd2>name</span>: PHPCS
</span><span style=display:block;width:100%;background-color:#19404a>        <span style=color:#268bd2>uses</span>: docker://phpqa/phpcs
</span><span style=display:block;width:100%;background-color:#19404a>        <span style=color:#268bd2>with</span>:
</span><span style=display:block;width:100%;background-color:#19404a>          <span style=color:#268bd2>args</span>: sh -c &#34;phpcs src --report=emacs | sed \&#34;s|^.*src|src|;s|\(.*\):\(.*\):\(.*\):\(.*\)|::error file=\1,line=\2,col=\3::\4|\&#34;&#34;
</span></code></pre></td></tr></table>
</div>
</div><p class=code-legend>docker in docker</p>
<h3 id=secrets>Secrets <a href=#secrets class=heading-anchor>¬∂</a></h3>
<p>Ainda tem um ponto importante para v√°rios fluxos de CI (e principalmente
Continuous Delivery), que √© lidar com informa√ß√µes sens√≠veis (chaves RSA, tokens
de acesso, JWTs, OAuth Client secrets, senhas).</p>
<p>Exceto quando o seu CI esta integrado com o provedor que ir√° executar o seu
ambiente (Openshift/Kubernetes), √© prov√°vel que voc√™ vai precisar ter alguma
chave para poder se conectar a sua VPS, seja para copiar arquivos via RSYNC,
fazer o push de imagens para registros do Docker, conectar via SSH, ou apenas
disparar algum evento no seu provedor.</p>
<p>E ter essa chave aberta no YAML do <code>workflow</code> esta longe de ser uma boa
pr√°tica, para resolver esse problema o Github permite que registremos valores
para o reposit√≥rio que s√£o acess√≠veis apenas dentro do <code>actions</code>.</p>
<p>Os &ldquo;segredos do reposit√≥rio&rdquo;, que s√£o acess√≠veis em todos os <code>workflows</code>
abertamente (exceto por forks que nesse caso precisa que um colaborador
aprove).</p>
<p>
<figure class=big>
<img class="lazyload blur-up" loading=lazy data-src=./github-secrets.png alt=github-secrets>
<figcaption><p>segredos do reposit√≥rio</p></figcaption>
</figure>
</p>
<p>Como falei, esses caras ficam dispon√≠veis para todos os <code>workflows</code>, e pode ser
usados simplesmente usando o contexto <code>secrets</code> no YAML.</p>
<p>Por exemplo, se o seu reposit√≥rio for privado, o Codecov obriga voc√™ a usar um
token para enviar o relat√≥rio de cobertura.</p>
<div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#495050">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">32
</span><span style=display:block;width:100%;background-color:#19404a><span style="margin-right:.4em;padding:0 .4em;color:#495050">33
</span></span><span style="margin-right:.4em;padding:0 .4em;color:#495050">34
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>      - <span style=color:#268bd2>name</span>: Upload coverage to Codecov
        <span style=color:#268bd2>uses</span>: codecov/codecov-action@v2
        <span style=color:#268bd2>with</span>:
<span style=display:block;width:100%;background-color:#19404a>          <span style=color:#268bd2>token</span>: ${{ secrets.CODECOV_TOKEN }}
</span>          <span style=color:#268bd2>files</span>: ./clover.xml
</code></pre></td></tr></table>
</div>
</div><p>Agora sempre que o <code>workflow</code> for executado o Github vai automaticamente
injetar o segredo na <code>step</code>.</p>
<h2 id=outros-eventos-e-usos>Outros eventos e usos <a href=#outros-eventos-e-usos class=heading-anchor>¬∂</a></h2>
<p>Agora que temos uma ideia de como criar os <code>workflows</code> e tamb√©m como combinar
<code>actions</code> prontas, seja do <a href=https://github.com/marketplace/actions>Github Marketplace</a> ou imagens do
Docker.</p>
<p>Vamos dar uma explorada em alguns outros eventos interessantes que podemos usar
nos <code>actions</code> que podem ser usados para alguns comportamentos customizados.</p>
<h3 id=cron-schedule>CRON (<code>schedule</code>) <a href=#cron-schedule class=heading-anchor>¬∂</a></h3>
<p>As CRONs no Github Actions rodam automaticamente com base numa periodicidade
que voc√™ definir, sempre usando a branch padr√£o do projeto.</p>
<p>Com esse evento podemos, por exemplo, avaliar se PRs ou Issues no Github est√£o
abertas por muito tempo, e dessa forma podem ser um risco, e marcar eles como
<code>stale</code>, ou notificar o time no Slack para n√£o ser esquecida.</p>
<p>Tamb√©m pode us√°-lo para rodar processos que sejam muito grandes/lentos para se
executar num PR ou no merge da branch.</p>
<p>Outros usos legais s√£o para automatizar e melhorar o seu perfil do Github, como
o <code>gautamkrishnar/blog-post-workflow</code> e o <code>athul/waka-readme</code>.</p>
<p>O <a href=https://github.com/gautamkrishnar/blog-post-workflow><code>gautamkrishnar/blog-post-workflow</code></a> consulta o RSS to seu blog
e insere as ultimas postagens que voc√™ fez.</p>
<p>E o <a href=https://github.com/athul/waka-readme><code>athul/waka-readme</code></a> puxa os dados do <a href=wip>Wakatime</a> e cria um
gr√°fico ASCII com base neles.</p>
<p>
<figure class=big>
<img class="lazyload blur-up" loading=lazy data-src=./github-cron-profile.png alt=github-file>
<figcaption><p>exemplo de cron alterando perfil do github</p></figcaption>
</figure>
</p>
<p>O <code>workflow</code> para atualizar o perfil com o Wakatime √© esse:</p>
<div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#495050"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">14
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#268bd2>name</span>: Wakatime
<span style=color:#268bd2>on</span>:
  <span style=color:#268bd2>schedule</span>:
    - <span style=color:#268bd2>cron</span>: <span style=color:#2aa198>&#34;0 0 * * *&#34;</span>

<span style=color:#268bd2>jobs</span>:
  <span style=color:#268bd2>update-readme</span>:
    <span style=color:#268bd2>name</span>: Update this repo&#39;s README
    <span style=color:#268bd2>runs-on</span>: ubuntu-latest
    <span style=color:#268bd2>steps</span>:
      - <span style=color:#268bd2>uses</span>: lucassabreu/waka-readme@master
        <span style=color:#268bd2>with</span>:
          <span style=color:#268bd2>WAKATIME_API_KEY</span>: ${{ secrets.WAKATIME_API_KEY }}
          <span style=color:#268bd2>SHOW_TIME</span>: <span style=color:#cb4b16>false</span>
</code></pre></td></tr></table>
</div>
</div><h3 id=pull-request-labels-labelled>Pull Request Labels (<code>labelled</code>) <a href=#pull-request-labels-labelled class=heading-anchor>¬∂</a></h3>
<p>Podemos ouvir quando s√£o modificadas as <code>labels</code> de um PR e com isso podemos
automatizar a subida de ambientes quando formos testar o mesmo, ou visualizar
como uma postagem vai ficar sem de fato publicar ela nosso blog pessoal.</p>
<div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#495050"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050"> 2
</span><span style=display:block;width:100%;background-color:#19404a><span style="margin-right:.4em;padding:0 .4em;color:#495050"> 3
</span></span><span style=display:block;width:100%;background-color:#19404a><span style="margin-right:.4em;padding:0 .4em;color:#495050"> 4
</span></span><span style="margin-right:.4em;padding:0 .4em;color:#495050"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050"> 7
</span><span style=display:block;width:100%;background-color:#19404a><span style="margin-right:.4em;padding:0 .4em;color:#495050"> 8
</span></span><span style="margin-right:.4em;padding:0 .4em;color:#495050"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">32
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">33
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#268bd2>name</span>: GH Pages (Preview PR)
<span style=color:#268bd2>on</span>:
<span style=display:block;width:100%;background-color:#19404a>  <span style=color:#268bd2>pull_request</span>:
</span><span style=display:block;width:100%;background-color:#19404a>    <span style=color:#268bd2>types</span>: [labeled]
</span>
<span style=color:#268bd2>jobs</span>:
  <span style=color:#268bd2>build-and-preview</span>:
<span style=display:block;width:100%;background-color:#19404a>    <span style=color:#268bd2>if</span>: ${{ github.event.label.name == &#39;preview-pr&#39; }}
</span>    <span style=color:#268bd2>runs-on</span>: ubuntu-latest
    <span style=color:#268bd2>steps</span>:
      - <span style=color:#268bd2>name</span>: Checkout üõéÔ∏è
        <span style=color:#268bd2>uses</span>: actions/checkout@v2.3.1
        <span style=color:#268bd2>with</span>:
          <span style=color:#268bd2>submodules</span>: <span style=color:#cb4b16>true</span>
          <span style=color:#268bd2>fetch-depth</span>: <span style=color:#2aa198>0</span>

      - <span style=color:#268bd2>name</span>: Setup Hugo
        <span style=color:#268bd2>uses</span>: peaceiris/actions-hugo@v2
        <span style=color:#268bd2>with</span>:
          <span style=color:#268bd2>hugo-version</span>: <span style=color:#2aa198>&#34;0.87.0&#34;</span>

      - <span style=color:#268bd2>name</span>: Build
        <span style=color:#268bd2>run</span>: |<span style=color:#2aa198>
</span><span style=color:#2aa198>          REL=preview/${{ github.event.number }}
</span><span style=color:#2aa198>          hugo -d public/$REL -v --minify \
</span><span style=color:#2aa198>            -b http://www.lucassabreu.net.br/$REL</span>          

      - <span style=color:#268bd2>name</span>: Deploy üöÄ
        <span style=color:#268bd2>uses</span>: JamesIves/github-pages-deploy-action@4.1.5
        <span style=color:#268bd2>with</span>:
          <span style=color:#268bd2>branch</span>: gh-pages
          <span style=color:#268bd2>folder</span>: public
          <span style=color:#268bd2>clean</span>: <span style=color:#cb4b16>false</span>
</code></pre></td></tr></table>
</div>
</div><p class=code-legend>trigger preview deploy</p>
<p>Se quiser ainda pode usar o <code>actions/github-script</code> para remover a <code>label</code> no
fim do deploy, e colocar outra para indicar que concluiu. Mas j√° deixar pronto
para iniciar o deploy de novo.</p>
<div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#495050">35
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">36
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">37
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">38
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">39
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">40
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">41
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">42
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">43
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">44
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">45
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">46
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">47
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">48
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">49
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>      - <span style=color:#268bd2>uses</span>: actions/github-script@v4
        <span style=color:#268bd2>with</span>:
          <span style=color:#268bd2>script</span>: |<span style=color:#2aa198>
</span><span style=color:#2aa198>            github.issues.removeLabel({
</span><span style=color:#2aa198>              owner: context.repo.owner,
</span><span style=color:#2aa198>              repo: context.repo.repo,
</span><span style=color:#2aa198>              issue_number: context.payload.number,
</span><span style=color:#2aa198>              name: &#39;preview-pr&#39;
</span><span style=color:#2aa198>            })
</span><span style=color:#2aa198>            github.issues.addLabels({
</span><span style=color:#2aa198>              owner: context.repo.owner,
</span><span style=color:#2aa198>              repo: context.repo.repo,
</span><span style=color:#2aa198>              issue_number: context.payload.number,
</span><span style=color:#2aa198>              labels: [&#39;preview-deployed&#39;]
</span><span style=color:#2aa198>            })</span>            
</code></pre></td></tr></table>
</div>
</div><p class=code-legend>apenas um extra para facilitar</p>
<p>Se quiser que seja feito para todos os commits feitos para o PR ent√£o seria
apenas mudar um pouco o cabe√ßalho do <code>workflow</code>:</p>
<div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#495050">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">6
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">7
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">8
</span><span style="margin-right:.4em;padding:0 .4em;color:#495050">9
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#268bd2>name</span>: GH Pages (Preview PR)
<span style=color:#268bd2>on</span>:
  <span style=color:#268bd2>pull_request</span>:
    <span style=color:#268bd2>types</span>: [labeled, opened, synchronize, reopened]

<span style=color:#268bd2>jobs</span>:
  <span style=color:#268bd2>build-and-preview</span>:
    <span style=color:#268bd2>if</span>: ${{ contains(github.event.pull_request.labels.*.name, &#39;preview-deployed&#39;) || github.event.label.name == &#39;preview-pr&#39; }}
    <span style=color:#268bd2>runs-on</span>: ubuntu-latest
</code></pre></td></tr></table>
</div>
</div><h3 id=coment√°rios-issue_comment>Coment√°rios (<code>issue_comment</code>) <a href=#coment%c3%a1rios-issue_comment class=heading-anchor>¬∂</a></h3>
<p>Ouvindo coment√°rios √© poss√≠vel criar comportamentos ainda mais complexos,
podendo criar um mini &ldquo;chat bot&rdquo; que reage a coment√°rios espec√≠ficos ou a
padr√µes de comando, que nem o bots do Slack ou do Discord.</p>
<p>Como esse <code>workflow</code> reage a eventos que n√£o tem necessariamente rela√ß√£o a
c√≥digo ele precisa estar estar na branch padr√£o para funcionar, ent√£o se
estiver criando alguma automa√ß√£o para um PR voc√™ n√£o vai conseguir testar ele
at√© chegar na <code>main</code>.</p>
<p>Usando apenas a API do Github da para fazer a uma vers√£o no <a href=https://en.wikipedia.org/wiki/Cowsay><code>cowsay</code></a>
via coment√°rios.</p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#268bd2>name</span>: <span style=color:#2aa198>&#34;Octocat say&#34;</span>
<span style=color:#268bd2>on</span>:
  <span style=color:#268bd2>issue_comment</span>:
    <span style=color:#268bd2>types</span>: [created]

<span style=color:#268bd2>jobs</span>:
  <span style=color:#268bd2>cowsay</span>:
    <span style=color:#268bd2>if</span>: <span style=color:#2aa198>&#34;${{ startsWith(github.event.comment.body, &#39;/say&#39;) }}&#34;</span>
    <span style=color:#268bd2>runs-on</span>: ubuntu-latest

    <span style=color:#268bd2>steps</span>:
      - <span style=color:#268bd2>name</span>: Octocat says
        <span style=color:#268bd2>uses</span>: actions/github-script@v5
        <span style=color:#268bd2>with</span>:
          <span style=color:#268bd2>script</span>: |<span style=color:#2aa198>
</span><span style=color:#2aa198>            const message = context.payload.comment.body.substring(5) ||
</span><span style=color:#2aa198>              (await github.rest.meta.getZen()).data;
</span><span style=color:#2aa198>            const say = await github.rest.meta.getOctocat({
</span><span style=color:#2aa198>              s: message
</span><span style=color:#2aa198>            });
</span><span style=color:#2aa198>            github.rest.issues.createComment({
</span><span style=color:#2aa198>              owner: context.repo.owner,
</span><span style=color:#2aa198>              repo: context.repo.repo,
</span><span style=color:#2aa198>              issue_number: context.payload.issue.number,
</span><span style=color:#2aa198>              body: &#34;```\n&#34; + (new TextDecoder().decode(say.data)) + &#34;\n```&#34;,
</span><span style=color:#2aa198>            });</span>            
</code></pre></div><p class=code-legend>`workflow` para responder coment√°rios</p>
<p>O <code>workflow</code> acima pode gerar esses dois resultados:</p>
<p>
<figure class=big>
<img class="lazyload blur-up" loading=lazy data-src=./octocat-say-quote.png alt>
<figcaption><p>uma frase aleat√≥ria com octocat</p></figcaption>
</figure>
<figure class=big>
<img class="lazyload blur-up" loading=lazy data-src=./octocat-say-repeat-me.png alt>
<figcaption><p>repete a frase passada</p></figcaption>
</figure>
</p>
<p>E aqui abre as portas da criatividade&mldr;</p>
<ul>
<li>iniciar um deploy e passar um prefixo para ser usado? <em>D√° para fazer!</em></li>
<li>promover a branch do PR para um ambiente espec√≠fico? <em>D√° para fazer!!</em></li>
<li>mandar uma c√≥pia do coment√°rio que acabou de escrever e os √∫ltimos
coment√°rios feitos no PR para um canal espec√≠fico no Slack para continuar a
conversar de forma mais s√≠ncrona? <em>D√° para fazer!!!</em></li>
</ul>
<h3 id=manual-workflow_dispatch-e-repository_dispatch>Manual (<code>workflow_dispatch</code> e <code>repository_dispatch</code>) <a href=#manual-workflow_dispatch-e-repository_dispatch class=heading-anchor>¬∂</a></h3>
<p>O <code>workflow_dispatch</code> e o <code>repository_dispatch</code> atende a situa√ß√£o em que voc√™
precisa iniciar um <code>workflow</code> para reagir a algum evento externo ao Github,
ele at√© pode ser autom√°tico do ponto de vista do seu processo, mas para o Github √©
praticamente o equivalente a um webhook.</p>
<p>Similar ao <code>issue_comment</code> como esses <code>workflows</code> reagem a a√ß√µes n√£o
necessariamente relacionadas a PRs, voc√™ vai precisar que eles estejam na
branch padr√£o para funcionar.</p>
<p>Dos dois o <code>workflow_dispatch</code> √© o mais orientado a ideia de ser um humano
disparando o mesmo, tendo uma sess√£o para descrever as entradas que ele espera
e uma UI do Github com base nessas entradas para facilitar o disparo.</p>
<p>Como nos outros casos, aqui √© uma quest√£o de criatividade e necessidade quanto
ao que pode ser feito, o mais comum √© criar um <code>workflow</code> para deploy do
projeto onde voc√™ pode informar qual o ambiente que ser√° atualizado e qual</p>
<h2 id=criar-actions>Criar Actions <a href=#criar-actions class=heading-anchor>¬∂</a></h2>
<p>Para criar uma <code>action</code> e publicar ela basta criar um reposit√≥rio p√∫blico no
Github, adicionar um <a href=https://docs.github.com/en/actions/creating-actions/metadata-syntax-for-github-actions><code>action.yaml</code></a> na raiz do projeto, e
publicar uma release, ao registrar ele ir√° confirmar se deseja adicionar no
marketplace e em qual categoria.</p>
<p>
<figure class=big>
<img class="lazyload blur-up" loading=lazy data-src=./marketplace-release.png alt=marketplace-release>
</figure>
</p>
</div><section class=share>
<p>
Share this post at
<a href="https://twitter.com/share?text=Github%20Actions&nbsp;-&nbsp;Lucas%20dos%20Santos%20Abreu&url=http%3a%2f%2fwww.lucassabreu.net.br%2fpreview%2f6%2fpost%2fgithub-actions%2f" onclick="return window.open(this.href,'twitter-share','width=550,height=235'),!1">
Twitter
</a>
<a href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2fwww.lucassabreu.net.br%2fpreview%2f6%2fpost%2fgithub-actions%2f" onclick="return window.open(this.href,'facebook-share','width=580,height=296'),!1">
Facebook
</a>
<a href="http://pinterest.com/pin/create/button/?url=http%3a%2f%2fwww.lucassabreu.net.br%2fpreview%2f6%2fpost%2fgithub-actions%2f&description=Github%20Actions" onclick="return window.open(this.href,'pinterest-share','width=580,height=296'),!1">
Pinterest
</a>
</p>
</section>
<footer>
<section role=comment>
<p>
<div id=disqus_thread></div>
<script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//lucas-dos-santos-abreu.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script>
<noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript>
<a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a>
</p>
</section>
<section>
<p>
Published
by <span itemprop=author></span>
<time datetime=2021-09-12T00:00:00+00:00>
12 Sep, 2021
</time>
and tagged
<a href=/preview/6/tags/github>Github</a>
<a href=/preview/6/tags/github-actions>Github Actions</a>
<a href=/preview/6/tags/continuous-integration>Continuous Integration</a>
using <span itemprop=wordCount>3033</span> words.
</p>
</section>
</footer>
</article>
</main>
<aside>
<header>Related Content</header>
<ul>
<li>
<a href=/preview/6/post/ambientes-por-branch-com-openshift-next-gen-usando-github/>Ambientes por Branch com OpenShift Next Gen usando¬†GitHub</a> &ndash;
<time>9 minute read</time>
</li>
<li>
<a href=/preview/6/post/ambientes-por-branch-com-openshift-next-gen/>Ambientes por Branch com OpenShift Next¬†Gen</a> &ndash;
<time>9 minute read</time>
</li>
<li>
<a href=/preview/6/post/simplificando-setup-projetos-github/>Simplificando o Setup de Projetos no GitHub</a> &ndash;
<time>2 minute read</time>
</li>
</ul>
</aside>
<footer>
<p>
&copy;
2021 ¬∑
This page was generated using <a target=_blank rel=noopener href=https://github.com/colorchestra/smol>smol<a> for <a target=_blank rel=noopener href=https://gohugo.io/>Hugo</a>.
</p>
</footer>
</body>
</html>