<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Github on Lucas dos Santos Abreu</title>
    <link>https://lucassabreu.net.br/tags/github/index.xml</link>
    <description>Recent content in Github on Lucas dos Santos Abreu</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>pt-BR</language>
    <atom:link href="https://lucassabreu.net.br/tags/github/index.xml" rel="self" type="application/rss+xml" />
    
    <item>
      <title>Ambientes por Branch com OpenShift Next Gen usando¬†GitHub</title>
      <link>https://lucassabreu.net.br/post/ambientes-por-branch-com-openshift-next-gen-usando-github/</link>
      <pubDate>Sun, 07 May 2017 00:00:00 +0000</pubDate>
      
      <guid>https://lucassabreu.net.br/post/ambientes-por-branch-com-openshift-next-gen-usando-github/</guid>
      <description>&lt;p&gt;&lt;/p&gt;


&lt;figure class=&#34;big&#34;&gt;
  
    
      &lt;img class=&#34;lazyload&#34; data-src=&#34;/post/ambientes-por-branch-com-openshift-next-gen-usando-github/header.png&#34;  /&gt;
    
  
  
&lt;/figure&gt;
&lt;style media=&#34;screen&#34;&gt;
  .blur-up {
    -webkit-filter: blur(5px);
    filter: blur(5px);
    transition: filter 400ms, -webkit-filter 400ms;
  }
  .blur-up.lazyloaded {
    -webkit-filter: blur(0);
    filter: blur(0);
  }
&lt;/style&gt;


&lt;p&gt;&lt;i&gt;Esta postagem √© uma continua√ß√£o da &lt;a href=&#34;https://lucassabreu.net.br/post/ambientes-por-branch-com-openshift-next-gen&#34;&gt;&lt;strong&gt;Ambientes por Branch com OpenShift Next Gen&lt;/strong&gt;&lt;/a&gt;, a introdu√ß√£o do problema esta l√° e tamb√©m mostro como implementar o processo de deploy usando o GitLab nele, se n√£o viu da uma conferida, vale o investimento* üòâ.&lt;/i&gt;&lt;/p&gt;

&lt;p&gt;Como prometi na outra postagem, vamos criar um processo de deploy de ambientes por branch usando o &lt;a href=&#34;https://medium.com/@github&#34;&gt;GitHub&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;No caso do GitHub, ele cobre &amp;ldquo;apenas&amp;rdquo; a parte de reposit√≥rio de fontes, ele em si n√£o tem integra√ß√£o direta com o Kubernetes/OpenShift, mas possui uma grande gama de op√ß√µes no que diz respeito de ferramentas de CI e CD.&lt;/p&gt;

&lt;p&gt;A implementa√ß√£o que vou demonstrar usar√° o &lt;a href=&#34;https://medium.com/@BuddyWorks&#34;&gt;Buddy&lt;/a&gt;, mas pode ser replicada para qualquer outro CI, com dificuldade semelhante. Para o registro de imagens irei usar o &lt;a href=&#34;http://hub.docker.com&#34;&gt;Docker Hub&lt;/a&gt; e novamente o OpenShift da &lt;a href=&#34;https://medium.com/@getupcloud&#34;&gt;Getup Cloud&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Sobre uma introdu√ß√£o ao Kubernetes/OpenShift pode ver aqui:&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;https://lucassabreu.net.br/post/um-ambiente-simples-usando-kubernetes-e-openshift-next-gen-parte-1/&#34;&gt;&lt;strong&gt;Um ambiente simples usando Kubernetes e OpenShift Next Gen‚Ää‚Äî‚ÄäParte 1&lt;/strong&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;O cliente de linha de comando do OpenShift pode ser baixado em:&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;https://github.com/openshift/origin/releases&#34;&gt;&lt;strong&gt;openshift/origin&lt;/strong&gt; origin - Enterprise Kubernetes for Developers&lt;/a&gt;&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;O que queremos montar √© um ambiente por branch/PR que deve ser facilmente criado e destru√≠do. Para demonstrar criei um reposit√≥rio no GitHub com uma aplica√ß√£o bem simples que apenas retorna uma p√°gina est√°tica, mas √© o suficiente para o objetivo.&lt;/p&gt;


&lt;figure &gt;
  
    
      &lt;img class=&#34;lazyload&#34; data-src=&#34;/post/ambientes-por-branch-com-openshift-next-gen-usando-github/helloworld.png&#34;  /&gt;
    
  
  
  &lt;figcaption&gt;
    &lt;header&gt;&lt;b&gt;retorno do servi√ßo helloworld&lt;/b&gt;&lt;/header&gt;
    
  &lt;/figcaption&gt;
  
&lt;/figure&gt;
&lt;style media=&#34;screen&#34;&gt;
  .blur-up {
    -webkit-filter: blur(5px);
    filter: blur(5px);
    transition: filter 400ms, -webkit-filter 400ms;
  }
  .blur-up.lazyloaded {
    -webkit-filter: blur(0);
    filter: blur(0);
  }
&lt;/style&gt;


&lt;p&gt;E configurei o Buddy para construir uma imagem com base nesse reposit√≥rio e publicar ela como &lt;a href=&#34;https://hub.docker.com/r/lucassabreu/k8s-pr-envs/&#34;&gt;lucassabreu/k8s-pr-envs&lt;/a&gt; no Docker Hub.&lt;/p&gt;

&lt;p&gt;Nesse momento o arquivo &lt;code&gt;buddy.yml&lt;/code&gt; esta assim:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #272822&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;pipeline&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;Build&amp;quot;&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;trigger_mode&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;ON_EVERY_PUSH&amp;quot;&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;ref_name&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;master&amp;quot;&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;actions&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
  &lt;span style=&#34;color: #f8f8f2&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;action&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;Build&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;Docker&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;image&amp;quot;&lt;/span&gt;
    &lt;span style=&#34;color: #ae81ff&#34;&gt;type&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;DOCKERFILE&amp;quot;&lt;/span&gt;
    &lt;span style=&#34;color: #ae81ff&#34;&gt;login&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;${DOCKER_HUB_USER}&amp;quot;&lt;/span&gt;
    &lt;span style=&#34;color: #ae81ff&#34;&gt;password&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;${DOCKER_HUB_PASSWORD}&amp;quot;&lt;/span&gt;
    &lt;span style=&#34;color: #ae81ff&#34;&gt;docker_image_tag&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;${execution.to_revision.revision}&amp;quot;&lt;/span&gt;
    &lt;span style=&#34;color: #ae81ff&#34;&gt;dockerfile_path&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;Dockerfile&amp;quot;&lt;/span&gt;
    &lt;span style=&#34;color: #ae81ff&#34;&gt;repository&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;lucassabreu/k8s-pr-envs&amp;quot;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;p class=&#34;code-legend&#34;&gt;buddy.yml&lt;/p&gt;

&lt;p&gt;O fonte nesse momento pode ser visto em:&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;https://github.com/lucassabreu/k8s-pr-envs/tree/v1&#34;&gt;&lt;strong&gt;lucassabreu/k8s-pr-envs&lt;/strong&gt; v1&lt;/a&gt;&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;Nesse primeiro momento n√£o possu√≠mos nenhum processo de deploy, seja de teste, produ√ß√£o ou por branch.&lt;/p&gt;

&lt;p&gt;Ent√£o vamos adicionar um processo de deploy no OpenShift para o ambiente de produ√ß√£o e testes, sendo que o ambiente de testes √© atualizado automaticamente para os commits na master e o de produ√ß√£o apenas quando um usu√°rio disparar o deploy via interface web do Buddy (&lt;a href=&#34;http://app.buddy.works/&#34;&gt;http://app.buddy.works/&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;Precisamos preparar o OpenShift para montar esse processo, primeiramente criamos um &lt;strong&gt;Namespace&lt;/strong&gt;. A forma como criamos um varia de vendor para vendor, no caso do OpenShift da &lt;a href=&#34;https://medium.com/@getupcloud&#34;&gt;Getup Cloud&lt;/a&gt;, basta ir em &lt;a href=&#34;https://portal.getupcloud.com/projects&#34;&gt;https://portal.getupcloud.com/projects&lt;/a&gt; e criar um novo projeto, o nome do projeto ser√° o &lt;strong&gt;Namespace.&lt;/strong&gt;&lt;/p&gt;


&lt;figure class=&#34;big&#34;&gt;
  
    
      &lt;img class=&#34;lazyload&#34; data-src=&#34;/post/ambientes-por-branch-com-openshift-next-gen-usando-github/getup-dashboard.png&#34;  /&gt;
    
  
  
&lt;/figure&gt;
&lt;style media=&#34;screen&#34;&gt;
  .blur-up {
    -webkit-filter: blur(5px);
    filter: blur(5px);
    transition: filter 400ms, -webkit-filter 400ms;
  }
  .blur-up.lazyloaded {
    -webkit-filter: blur(0);
    filter: blur(0);
  }
&lt;/style&gt;


&lt;p&gt;Tendo um &lt;strong&gt;Namespace&lt;/strong&gt; precisamos de uma forma do Buddy se autenticar contra o OpenShift, para isso podemos criar um ServiceAccount e usar o &lt;strong&gt;Token&lt;/strong&gt; do mesmo para isso. O script abaixo mostra como criar uma ServiceAccount e resgatar o &lt;strong&gt;Token&lt;/strong&gt; usando o CLI do OpenShift:&lt;/p&gt;

&lt;pre&gt;
&lt;b&gt;$ oc login https://api.getupcloud.com:443&lt;/b&gt;
Authentication required for https://api.getupcloud.com:443 ...
Username: lucas.s.abreu@gmail.com
Password:
Login successful.
...

&lt;b&gt;$ oc project github-k8s-pr-envs #usar o seu projeto&lt;/b&gt;
Now using project &#34;github-k8s-pr-envs&#34; on server ...

&lt;b&gt;$ oc create serviceaccount github&lt;/b&gt;
serviceaccount &#34;github&#34; created

&lt;b&gt;$ oc policy add-role-to-user admin \
    system:serviceaccount:github-k8s-pr-envs:github&lt;/b&gt;

&lt;b&gt;$ oc describe serviceaccount github&lt;/b&gt;
Name:  github
Namespace: github-k8s-pr-envs
Labels:  &lt;none&gt;

Image pull secrets: github-dockercfg-vat7r

Mountable secrets:  github-token-d3u3t
                    github-dockercfg-vat7r

Tokens:             github-token-2pimz
                    github-token-d3u3t

&lt;b&gt;$ oc describe secret github-token-d3u3t&lt;/b&gt;
Name:  github-token-d3u3t
Namespace: github-k8s-pr-envs
Labels:  &lt;none&gt;
Annotations: kubernetes.io/service-account.name=github
  kubernetes.io/service-account.uid=zzz

Type: kubernetes.io/service-account-token

Data
====
ca.crt:  1066 bytes
namespace: 18 bytes
service-ca.crt: 2182 bytes
token:  &lt;i&gt;token-do-openshift-que-estou-ocultando&lt;/i&gt;
&lt;/pre&gt;

&lt;p&gt;Agora podemos informar no Buddy algumas vari√°veis para ele disponibilizar para n√≥s depois. Meu painel ficou como abaixo:&lt;/p&gt;


&lt;figure &gt;
  
    
      &lt;img class=&#34;lazyload&#34; data-src=&#34;/post/ambientes-por-branch-com-openshift-next-gen-usando-github/buddy-envs.png&#34;  /&gt;
    
  
  
  &lt;figcaption&gt;
    &lt;header&gt;&lt;b&gt;buddy environments&lt;/b&gt;&lt;/header&gt;
    
  &lt;/figcaption&gt;
  
&lt;/figure&gt;
&lt;style media=&#34;screen&#34;&gt;
  .blur-up {
    -webkit-filter: blur(5px);
    filter: blur(5px);
    transition: filter 400ms, -webkit-filter 400ms;
  }
  .blur-up.lazyloaded {
    -webkit-filter: blur(0);
    filter: blur(0);
  }
&lt;/style&gt;


&lt;p&gt;A URL da API e o dom√≠nio que o OpenShift ir√° utilizar tamb√©m dependem do seu vendor, no meu caso a API est√° em &lt;code&gt;https://api.getupcould.com:443&lt;/code&gt; e o dom√≠nio base √© &lt;code&gt;getup.io&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Agora podemos criar os novos pipelines no Buddy. No &lt;code&gt;buddy.yml&lt;/code&gt; as linhas abaixo:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #272822&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;pipeline&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;Deploy&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;Staging&amp;quot;&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;trigger_mode&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;ON_EVERY_PUSH&amp;quot;&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;ref_name&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;master&amp;quot;&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;actions&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
  &lt;span style=&#34;color: #f8f8f2&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;action&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;Deploy&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;Master&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;to&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;Staging&amp;quot;&lt;/span&gt;
    &lt;span style=&#34;color: #ae81ff&#34;&gt;type&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;BUILD&amp;quot;&lt;/span&gt;
    &lt;span style=&#34;color: #ae81ff&#34;&gt;docker_image_name&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;lucassabreu/openshift-k8s-cli&amp;quot;&lt;/span&gt;
    &lt;span style=&#34;color: #ae81ff&#34;&gt;docker_image_tag&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;latest&amp;quot;&lt;/span&gt;
    &lt;span style=&#34;color: #ae81ff&#34;&gt;execute_commands&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
    &lt;span style=&#34;color: #f8f8f2&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;TAG=&amp;quot;${execution.to_revision.revision}&amp;quot;&lt;/span&gt;
      &lt;span style=&#34;color: #ae81ff&#34;&gt;ENV=staging&lt;/span&gt;
      &lt;span style=&#34;color: #ae81ff&#34;&gt;OPENSHIFT_NAMESPACE=&amp;quot;${OPENSHIFT_NAMESPACE}&amp;quot;&lt;/span&gt;
      &lt;span style=&#34;color: #ae81ff&#34;&gt;OPENSHIFT_API_URL=&amp;quot;${OPENSHIFT_API_URL}&amp;quot;&lt;/span&gt;
      &lt;span style=&#34;color: #ae81ff&#34;&gt;OPENSHIFT_TOKEN=&amp;quot;${OPENSHIFT_TOKEN}&amp;quot;&lt;/span&gt;
      &lt;span style=&#34;color: #ae81ff&#34;&gt;OPENSHIFT_DOMAIN=&amp;quot;${OPENSHIFT_DOMAIN}&amp;quot;&lt;/span&gt;
      &lt;span style=&#34;color: #ae81ff&#34;&gt;./k8s/deploy&lt;/span&gt;
&lt;span style=&#34;color: #f8f8f2&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;pipeline&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;Deploy&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;Production&amp;quot;&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;trigger_mode&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;MANUAL&amp;quot;&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;ref_name&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;master&amp;quot;&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;actions&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
  &lt;span style=&#34;color: #f8f8f2&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;action&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;Deploy&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;Master&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;to&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;Production&amp;quot;&lt;/span&gt;
    &lt;span style=&#34;color: #ae81ff&#34;&gt;type&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;BUILD&amp;quot;&lt;/span&gt;
    &lt;span style=&#34;color: #ae81ff&#34;&gt;docker_image_name&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;lucassabreu/openshift-k8s-cli&amp;quot;&lt;/span&gt;
    &lt;span style=&#34;color: #ae81ff&#34;&gt;docker_image_tag&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;latest&amp;quot;&lt;/span&gt;
    &lt;span style=&#34;color: #ae81ff&#34;&gt;execute_commands&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
    &lt;span style=&#34;color: #f8f8f2&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;TAG=&amp;quot;${execution.to_revision.revision}&amp;quot;&lt;/span&gt;
      &lt;span style=&#34;color: #ae81ff&#34;&gt;ENV=production&lt;/span&gt;
      &lt;span style=&#34;color: #ae81ff&#34;&gt;OPENSHIFT_NAMESPACE=&amp;quot;${OPENSHIFT_NAMESPACE}&amp;quot;&lt;/span&gt;
      &lt;span style=&#34;color: #ae81ff&#34;&gt;OPENSHIFT_API_URL=&amp;quot;${OPENSHIFT_API_URL}&amp;quot;&lt;/span&gt;
      &lt;span style=&#34;color: #ae81ff&#34;&gt;OPENSHIFT_TOKEN=&amp;quot;${OPENSHIFT_TOKEN}&amp;quot;&lt;/span&gt;
      &lt;span style=&#34;color: #ae81ff&#34;&gt;OPENSHIFT_DOMAIN=&amp;quot;${OPENSHIFT_DOMAIN}&amp;quot;&lt;/span&gt;
      &lt;span style=&#34;color: #ae81ff&#34;&gt;./k8s/deploy&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;p class=&#34;code-legend&#34;&gt;buddy.yml (v2)&lt;/p&gt;

&lt;p&gt;Basicamente criei duas novas pipelines, uma chamada &lt;code&gt;Deploy Staging&lt;/code&gt; e outra &lt;code&gt;Deploy Production&lt;/code&gt; as √∫nicas diferen√ßas entre elas √© que a &lt;code&gt;Deploy Staging&lt;/code&gt; √© autom√°tica para todo o commit na master e usa &lt;code&gt;ENV=staging&lt;/code&gt; para indicar o ambiente; e &lt;code&gt;Deploy Production&lt;/code&gt; √© manual e usa &lt;code&gt;ENV=production&lt;/code&gt;. Tamb√©m criei vari√°veis para injetar os valores que informamos antes no Buddy e uma extra &lt;code&gt;COMMIT&lt;/code&gt; para que ele consiga identificar qual imagem deve usar.&lt;/p&gt;

&lt;p&gt;Essas duas pipelines basicamente chamam o script abaixo:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #272822&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #75715e&#34;&gt;#!/bin/bash&lt;/span&gt;

&lt;span style=&#34;color: #f8f8f2&#34;&gt;echo&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;&amp;gt;&amp;gt; Connecting to OpenShift...&amp;quot;&lt;/span&gt;
oc login &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;$OPENSHIFT_API_URL&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;&lt;/span&gt; --token &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;$OPENSHIFT_TOKEN&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;&lt;/span&gt;
oc project &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;$OPENSHIFT_NAMESPACE&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;&lt;/span&gt;

&lt;span style=&#34;color: #f8f8f2&#34;&gt;echo&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;&amp;gt;&amp;gt; Removing old application...&amp;quot;&lt;/span&gt;
oc delete all -l &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;app=&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;$ENV&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;&lt;/span&gt;

&lt;span style=&#34;color: #f8f8f2&#34;&gt;IMAGE_TAG&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;lucassabreu/k8s-pr-envs:&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;$TAG&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;&lt;/span&gt;
&lt;span style=&#34;color: #f8f8f2&#34;&gt;HOSTNAME&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;$OPENSHIFT_NAMESPACE&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;$ENV&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;$OPENSHIFT_DOMAIN&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;&lt;/span&gt;

&lt;span style=&#34;color: #66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;[&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;$ENV&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;production&amp;quot;&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;]&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;;&lt;/span&gt; &lt;span style=&#34;color: #66d9ef&#34;&gt;then&lt;/span&gt;
    &lt;span style=&#34;color: #f8f8f2&#34;&gt;HOSTNAME&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;$OPENSHIFT_NAMESPACE&lt;/span&gt;.&lt;span style=&#34;color: #f8f8f2&#34;&gt;$OPENSHIFT_DOMAIN&lt;/span&gt;
&lt;span style=&#34;color: #66d9ef&#34;&gt;fi&lt;/span&gt;

&lt;span style=&#34;color: #f8f8f2&#34;&gt;echo&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;&amp;gt;&amp;gt; Deploying application...&amp;quot;&lt;/span&gt;
sed &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;&lt;/span&gt;
&lt;span style=&#34;color: #e6db74&#34;&gt;    s|__ENV__|&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;$ENV&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;|;&lt;/span&gt;
&lt;span style=&#34;color: #e6db74&#34;&gt;    s|__IMAGE_TAG__|&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;$IMAGE_TAG&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;|;&lt;/span&gt;
&lt;span style=&#34;color: #e6db74&#34;&gt;    s|__HOSTNAME__|&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;$HOSTNAME&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;|;&lt;/span&gt;
&lt;span style=&#34;color: #e6db74&#34;&gt;    &amp;quot;&lt;/span&gt; k8s/full.yml &lt;span style=&#34;color: #f8f8f2&#34;&gt;|&lt;/span&gt; oc apply -f -

&lt;span style=&#34;color: #f8f8f2&#34;&gt;echo&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;Enviroment &lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;$ENV&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt; deployed to: http://&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;$HOSTNAME&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;/&amp;quot;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;p class=&#34;code-legend&#34;&gt;k8s/deploy&lt;/p&gt;

&lt;p&gt;Este script basicamente se autentica contra a API do OpenShift usando o Token que criamos antes, destr√≥i a aplica√ß√£o antiga e executa o deploy
de uma nova.&lt;/p&gt;

&lt;p&gt;Para poder identificar quais os componentes de cada ambiente estou marcando eles com a label &lt;code&gt;app=$ENV&lt;/code&gt;, dessa forma todos os componentes do ambiente &lt;code&gt;staging&lt;/code&gt; est√£o marcados com &lt;code&gt;app=staging&lt;/code&gt; e fica f√°cil elimin√°-los e identific√°-los.&lt;/p&gt;

&lt;p&gt;√â importante ressaltar que estou usando uma imagem customizada para rodar esses comandos (&lt;code&gt;lucassabreu/openshift-k8s-cli&lt;/code&gt;) que basicamente √© um &lt;code&gt;ubuntu&lt;/code&gt; com o &lt;code&gt;oc&lt;/code&gt; instalado dentro dela.&lt;/p&gt;

&lt;p&gt;Tamb√©m estou usando um truque de &amp;ldquo;&lt;em&gt;templating&lt;/em&gt;&amp;rdquo; com o YAML que define os ambientes para poder inserir as vari√°veis de cada ambiente nele. Existem outras ferramentas mais avan√ßadas como o &lt;a href=&#34;https://github.com/kubernetes/helm&#34;&gt;Helm&lt;/a&gt;, mas para o meu exemplo templating com &lt;code&gt;sed&lt;/code&gt; √© o suficiente.&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #272822&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #ae81ff&#34;&gt;apiVersion&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;extensions/v1beta1&lt;/span&gt;
&lt;span style=&#34;color: #ae81ff&#34;&gt;kind&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;Deployment&lt;/span&gt;
&lt;span style=&#34;color: #ae81ff&#34;&gt;metadata&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;name&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;hw-dpl-__ENV__&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;labels&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
    &lt;span style=&#34;color: #ae81ff&#34;&gt;app&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;__ENV__&lt;/span&gt;
&lt;span style=&#34;color: #ae81ff&#34;&gt;spec&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;replicas&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;1&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;template&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
    &lt;span style=&#34;color: #ae81ff&#34;&gt;metadata&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
      &lt;span style=&#34;color: #ae81ff&#34;&gt;labels&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
        &lt;span style=&#34;color: #ae81ff&#34;&gt;app&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;__ENV__&lt;/span&gt;
        &lt;span style=&#34;color: #ae81ff&#34;&gt;name&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;hw-pod&lt;/span&gt;
    &lt;span style=&#34;color: #ae81ff&#34;&gt;spec&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
      &lt;span style=&#34;color: #ae81ff&#34;&gt;containers&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
      &lt;span style=&#34;color: #f8f8f2&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;name&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;hw-container&lt;/span&gt;
        &lt;span style=&#34;color: #ae81ff&#34;&gt;image&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;__IMAGE_TAG__&lt;/span&gt;
        &lt;span style=&#34;color: #ae81ff&#34;&gt;imagePullPolicy&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;Always&lt;/span&gt;
        &lt;span style=&#34;color: #ae81ff&#34;&gt;ports&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
        &lt;span style=&#34;color: #f8f8f2&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;name&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;web-port&lt;/span&gt;
          &lt;span style=&#34;color: #ae81ff&#34;&gt;containerPort&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;8080&lt;/span&gt;
&lt;span style=&#34;color: #f8f8f2&#34;&gt;---&lt;/span&gt;
&lt;span style=&#34;color: #ae81ff&#34;&gt;apiVersion&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;v1&amp;quot;&lt;/span&gt;
&lt;span style=&#34;color: #ae81ff&#34;&gt;kind&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;Service&lt;/span&gt;
&lt;span style=&#34;color: #ae81ff&#34;&gt;metadata&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;name&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;hw-src-__ENV__&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;labels&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
    &lt;span style=&#34;color: #ae81ff&#34;&gt;app&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;__ENV__&lt;/span&gt;
&lt;span style=&#34;color: #ae81ff&#34;&gt;spec&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;ports&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
    &lt;span style=&#34;color: #f8f8f2&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;port&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;80&lt;/span&gt;
      &lt;span style=&#34;color: #ae81ff&#34;&gt;targetPort&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;web-port&amp;quot;&lt;/span&gt;
      &lt;span style=&#34;color: #ae81ff&#34;&gt;protocol&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;TCP&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;selector&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
    &lt;span style=&#34;color: #ae81ff&#34;&gt;name&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;hw-pod&lt;/span&gt;
    &lt;span style=&#34;color: #ae81ff&#34;&gt;app&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;__ENV__&lt;/span&gt;
&lt;span style=&#34;color: #f8f8f2&#34;&gt;---&lt;/span&gt;
&lt;span style=&#34;color: #ae81ff&#34;&gt;apiVersion&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;v1&lt;/span&gt;
&lt;span style=&#34;color: #ae81ff&#34;&gt;kind&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;Route&lt;/span&gt;
&lt;span style=&#34;color: #ae81ff&#34;&gt;metadata&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;name&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;__ENV__&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;labels&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
    &lt;span style=&#34;color: #ae81ff&#34;&gt;app&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;__ENV__&lt;/span&gt;
&lt;span style=&#34;color: #ae81ff&#34;&gt;spec&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;host&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;__HOSTNAME__&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;to&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
    &lt;span style=&#34;color: #ae81ff&#34;&gt;kind&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;Service&lt;/span&gt;
    &lt;span style=&#34;color: #ae81ff&#34;&gt;name&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;hw-src-__ENV__&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;p class=&#34;code-legend&#34;&gt;k8s/full.yml&lt;/p&gt;

&lt;p&gt;Agora toda vez que √© feito commit na master o ambiente de &lt;em&gt;staging&lt;/em&gt; √© automaticamente atualizado, e ficou bem simples atualizar o ambiente &lt;em&gt;production&lt;/em&gt;.&lt;/p&gt;

&lt;p&gt;Fonte at√© agora:&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;https://github.com/lucassabreu/k8s-pr-envs/tree/v2&#34;&gt;&lt;strong&gt;lucassabreu/k8s-pr-envs&lt;/strong&gt; v2&lt;/a&gt;&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;Agora que temos um processo de &lt;em&gt;build&lt;/em&gt; e um de &lt;em&gt;deploy automatizado&lt;/em&gt;, vamos adicionar a fun√ß√£o de deploy por branch.&lt;/p&gt;

&lt;p&gt;Basicamente precisamos de duas novas etapas no nosso CI, uma para subir o ambiente para uma branch e outro para destruir esse ambiente.&lt;/p&gt;

&lt;p&gt;Primeiro vamos preparar o deploy por branch, para isso adicionei as seguintes linhas do &lt;code&gt;buddy.yml&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #272822&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;pipeline&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;Review&amp;quot;&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;trigger_mode&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;ON_EVERY_PUSH&amp;quot;&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;ref_name&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;((?!master).*)&amp;quot;&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;actions&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
  &lt;span style=&#34;color: #f8f8f2&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;action&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;Build&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;Docker&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;image&amp;quot;&lt;/span&gt;
    &lt;span style=&#34;color: #ae81ff&#34;&gt;type&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;DOCKERFILE&amp;quot;&lt;/span&gt;
    &lt;span style=&#34;color: #ae81ff&#34;&gt;login&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;${DOCKER_HUB_USER}&amp;quot;&lt;/span&gt;
    &lt;span style=&#34;color: #ae81ff&#34;&gt;password&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;${DOCKER_HUB_PASSWORD}&amp;quot;&lt;/span&gt;
    &lt;span style=&#34;color: #ae81ff&#34;&gt;docker_image_tag&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;${execution.branch.name}&amp;quot;&lt;/span&gt;
    &lt;span style=&#34;color: #ae81ff&#34;&gt;dockerfile_path&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;Dockerfile&amp;quot;&lt;/span&gt;
    &lt;span style=&#34;color: #ae81ff&#34;&gt;repository&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;lucassabreu/k8s-pr-envs&amp;quot;&lt;/span&gt;
  &lt;span style=&#34;color: #f8f8f2&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;action&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;Deploy&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;By&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;Branch&amp;quot;&lt;/span&gt;
    &lt;span style=&#34;color: #ae81ff&#34;&gt;type&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;BUILD&amp;quot;&lt;/span&gt;
    &lt;span style=&#34;color: #ae81ff&#34;&gt;docker_image_name&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;lucassabreu/openshift-k8s-cli&amp;quot;&lt;/span&gt;
    &lt;span style=&#34;color: #ae81ff&#34;&gt;docker_image_tag&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;latest&amp;quot;&lt;/span&gt;
    &lt;span style=&#34;color: #ae81ff&#34;&gt;execute_commands&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
    &lt;span style=&#34;color: #f8f8f2&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;TAG=&amp;quot;${execution.branch.name}&amp;quot;&lt;/span&gt;
      &lt;span style=&#34;color: #ae81ff&#34;&gt;ENV=&amp;quot;${execution.branch.name}&amp;quot;&lt;/span&gt;
      &lt;span style=&#34;color: #ae81ff&#34;&gt;GITHUB_TOKEN=&amp;quot;${GITHUB_TOKEN}&amp;quot;&lt;/span&gt;
      &lt;span style=&#34;color: #ae81ff&#34;&gt;LOG_URL=&amp;quot;${execution.html_url}&amp;quot;&lt;/span&gt;
      &lt;span style=&#34;color: #ae81ff&#34;&gt;OPENSHIFT_NAMESPACE=&amp;quot;${OPENSHIFT_NAMESPACE}&amp;quot;&lt;/span&gt;
      &lt;span style=&#34;color: #ae81ff&#34;&gt;OPENSHIFT_API_URL=&amp;quot;${OPENSHIFT_API_URL}&amp;quot;&lt;/span&gt;
      &lt;span style=&#34;color: #ae81ff&#34;&gt;OPENSHIFT_TOKEN=&amp;quot;${OPENSHIFT_TOKEN}&amp;quot;&lt;/span&gt;
      &lt;span style=&#34;color: #ae81ff&#34;&gt;OPENSHIFT_DOMAIN=&amp;quot;${OPENSHIFT_DOMAIN}&amp;quot;&lt;/span&gt;
      &lt;span style=&#34;color: #ae81ff&#34;&gt;./k8s/deploy&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;No novo pipeline &lt;em&gt;Review&lt;/em&gt; temos um &lt;em&gt;build&lt;/em&gt; da imagem e um deploy de um ambiente para a branch em quest√£o, para uma rota pr√≥pria.&lt;/p&gt;

&lt;p&gt;Eu acabei juntando essas duas a√ß√µes, pois o build que roda na master vai versionando as imagens por commit, que √© uma pr√°tica comum e que ajudaria a fazer o deploy para produ√ß√£o mais simples, por√©m branchs de desenvolvimento tendem a ser mais ca√≥ticas e iriam poluir muito o registro de imagens (se usar o do AWS seria um custo maior tamb√©m), ent√£o preferi manter uma imagem por branch, at√© para n√£o confundir tamb√©m.&lt;/p&gt;

&lt;p&gt;Se eu criar uma nova branch nesse momento, o Buddy automaticamente ir√° montar uma imagem para ela e inseri-la no OpenShift, se o nome da branch for &lt;code&gt;a-change&lt;/code&gt; o nome do ambiente &lt;a href=&#34;http://github-k8s-pr-envs-a-change.getup.io&#34;&gt;http://github-k8s-pr-envs-a-change.getup.io&lt;/a&gt; (talvez ainda esteja acess√≠vel).&lt;/p&gt;

&lt;p&gt;Eu sei disso porque eu escrevi o script, eu poderia documentar isso no projeto para todos saberem como descobrir as URLs corretas, mas √© mais do que natural esperar erros por esse caminho, um &amp;ldquo;o&amp;rdquo; que vira &amp;ldquo;a&amp;rdquo; na hora de digitar, um nome de branch estranho, etc.&lt;/p&gt;

&lt;p&gt;Dessa forma fica dif√≠cil para a equipe de QA acessar aos ambientes por branch toda a vez correndo o risco de errar. Ent√£o fiz algumas altera√ß√µes no &lt;code&gt;k8s/deploy&lt;/code&gt; para utilizar a &lt;a href=&#34;https://developer.github.com/v3/repos/deployments/&#34;&gt;API de Deployments do GitHub&lt;/a&gt; para registrar as URLs diretamente nos commits.&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #272822&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;[&lt;/span&gt; ! -z &lt;span style=&#34;color: #f8f8f2&#34;&gt;$GITHUB_TOKEN&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;]&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;[&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;$ENV&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;&lt;/span&gt; !&lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;production&amp;quot;&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;]&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;[&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;$ENV&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;&lt;/span&gt; !&lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;staging&amp;quot;&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;]&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;;&lt;/span&gt; &lt;span style=&#34;color: #66d9ef&#34;&gt;then&lt;/span&gt;
    &lt;span style=&#34;color: #f8f8f2&#34;&gt;echo&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;&amp;gt;&amp;gt; Registering &lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;$ENV&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt; deployment...&amp;quot;&lt;/span&gt;

    &lt;span style=&#34;color: #f8f8f2&#34;&gt;ID_DEPLOYMENT&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color: #66d9ef&#34;&gt;$(&lt;/span&gt;k8s/github-deployment &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;lucassabreu/k8s-pr-envs&amp;quot;&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;$GITHUB_TOKEN&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;&lt;/span&gt; create &lt;span style=&#34;color: #ae81ff&#34;&gt;\&lt;/span&gt;
        &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;$ENV&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;$ENV&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;true&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;|&lt;/span&gt; jq &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;.id&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #66d9ef&#34;&gt;)&lt;/span&gt;
    &lt;span style=&#34;color: #f8f8f2&#34;&gt;RETURN&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color: #66d9ef&#34;&gt;$(&lt;/span&gt;k8s/github-deployment &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;lucassabreu/k8s-pr-envs&amp;quot;&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;$GITHUB_TOKEN&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;&lt;/span&gt; status &lt;span style=&#34;color: #f8f8f2&#34;&gt;set&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;\&lt;/span&gt;
        &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;$ID_DEPLOYMENT&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;&lt;/span&gt; success &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;http://&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;$HOSTNAME&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;/&amp;quot;&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;$LOG_URL&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #66d9ef&#34;&gt;)&lt;/span&gt;
    &lt;span style=&#34;color: #66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;[&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #66d9ef&#34;&gt;$(&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;echo&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;$RETURN&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;|&lt;/span&gt; jq &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;.message&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #66d9ef&#34;&gt;)&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;&lt;/span&gt; !&lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;null&amp;quot;&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;]&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;;&lt;/span&gt; &lt;span style=&#34;color: #66d9ef&#34;&gt;then&lt;/span&gt;
        &lt;span style=&#34;color: #f8f8f2&#34;&gt;echo&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;$RETURN&lt;/span&gt;
        &lt;span style=&#34;color: #f8f8f2&#34;&gt;exit&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;1&lt;/span&gt;
    &lt;span style=&#34;color: #66d9ef&#34;&gt;fi&lt;/span&gt;
&lt;span style=&#34;color: #66d9ef&#34;&gt;fi&lt;/span&gt;

&lt;span style=&#34;color: #f8f8f2&#34;&gt;echo&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;Enviroment &lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;$ENV&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt; deployed to: http://&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;$HOSTNAME&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;/&amp;quot;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;p class=&#34;code-legend&#34;&gt;deploy.sh&lt;/p&gt;

&lt;p&gt;Com isso fa√ßo algumas chamadas a API do GitHub usando o &lt;code&gt;k8s/github-deployment&lt;/code&gt; (que √© basicamente um facilitador para a API) e consigo registrar o deploy no GitHub.&lt;/p&gt;

&lt;p&gt;O Pull Request da branch &lt;code&gt;a-change&lt;/code&gt; fica assim:&lt;/p&gt;


&lt;figure &gt;
  
    
      &lt;img class=&#34;lazyload&#34; data-src=&#34;/post/ambientes-por-branch-com-openshift-next-gen-usando-github/github-deployments.png&#34;  /&gt;
    
  
  
&lt;/figure&gt;
&lt;style media=&#34;screen&#34;&gt;
  .blur-up {
    -webkit-filter: blur(5px);
    filter: blur(5px);
    transition: filter 400ms, -webkit-filter 400ms;
  }
  .blur-up.lazyloaded {
    -webkit-filter: blur(0);
    filter: blur(0);
  }
&lt;/style&gt;


&lt;p&gt;Nesse bot√£o &amp;ldquo;View deployment&amp;rdquo; est√° o link para a rota que criamos no deploy, e dessa forma fica extremamente f√°cil para a equipe de QA acessar os ambientes.&lt;/p&gt;

&lt;p&gt;Fontes at√© agora:&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;https://github.com/lucassabreu/k8s-pr-envs/tree/v3.1&#34;&gt;&lt;strong&gt;lucassabreu/k8s-pr-envs&lt;/strong&gt; v3.1&lt;/a&gt;&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;Ainda fica faltando uma √∫ltima atividade por realizar, que √© destruir o ambiente da branch quando os Testers n√£o mais precisarem deles.&lt;/p&gt;

&lt;p&gt;Ent√£o vamos adicionar uma nova pipeline no &lt;code&gt;buddy.yml&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #272822&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;pipeline&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;Close&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;Review&amp;quot;&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;trigger_mode&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;MANUAL&amp;quot;&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;ref_name&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;((?!master).*)&amp;quot;&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;actions&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
  &lt;span style=&#34;color: #f8f8f2&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;action&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;Destroy&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;Branch&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt; &lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;Environment&amp;quot;&lt;/span&gt;
    &lt;span style=&#34;color: #ae81ff&#34;&gt;type&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;BUILD&amp;quot;&lt;/span&gt;
    &lt;span style=&#34;color: #ae81ff&#34;&gt;docker_image_name&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;lucassabreu/openshift-k8s-cli&amp;quot;&lt;/span&gt;
    &lt;span style=&#34;color: #ae81ff&#34;&gt;docker_image_tag&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;latest&amp;quot;&lt;/span&gt;
    &lt;span style=&#34;color: #ae81ff&#34;&gt;execute_commands&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
    &lt;span style=&#34;color: #f8f8f2&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;ENV=&amp;quot;${execution.branch.name}&amp;quot;&lt;/span&gt;
      &lt;span style=&#34;color: #ae81ff&#34;&gt;GITHUB_TOKEN=&amp;quot;${GITHUB_TOKEN}&amp;quot;&lt;/span&gt;
      &lt;span style=&#34;color: #ae81ff&#34;&gt;OPENSHIFT_NAMESPACE=&amp;quot;${OPENSHIFT_NAMESPACE}&amp;quot;&lt;/span&gt;
      &lt;span style=&#34;color: #ae81ff&#34;&gt;OPENSHIFT_API_URL=&amp;quot;${OPENSHIFT_API_URL}&amp;quot;&lt;/span&gt;
      &lt;span style=&#34;color: #ae81ff&#34;&gt;OPENSHIFT_TOKEN=&amp;quot;${OPENSHIFT_TOKEN}&amp;quot;&lt;/span&gt;
      &lt;span style=&#34;color: #ae81ff&#34;&gt;./k8s/destroy&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Nesse pipeline manual basicamente chamamos o script &lt;code&gt;k8s/destroy&lt;/code&gt; (que esta abaixo) que simplesmente destr√≥i o ambiente inativa ele no GitHub.&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #272822&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #75715e&#34;&gt;#!/bin/bash&lt;/span&gt;

&lt;span style=&#34;color: #f8f8f2&#34;&gt;echo&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;&amp;gt;&amp;gt; Connecting to OpenShift...&amp;quot;&lt;/span&gt;
oc login &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;$OPENSHIFT_API_URL&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;&lt;/span&gt; --token &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;$OPENSHIFT_TOKEN&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;&lt;/span&gt;
oc project &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;$OPENSHIFT_NAMESPACE&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;&lt;/span&gt;

&lt;span style=&#34;color: #f8f8f2&#34;&gt;echo&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;&amp;gt;&amp;gt; Removing old application...&amp;quot;&lt;/span&gt;
oc delete all -l &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;app=&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;$ENV&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;&lt;/span&gt;

k8s/github-deployment &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;lucassabreu/k8s-pr-envs&amp;quot;&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;$GITHUB_TOKEN&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;&lt;/span&gt; inactive &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;$ENV&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;&lt;/span&gt; &amp;gt;&amp;gt; /dev/null
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Agora podemos chamar ele para eliminar os ambientes de branch em aberto.&lt;/p&gt;

&lt;p&gt;Fontes at√© o momento:&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;https://github.com/lucassabreu/k8s-pr-envs/tree/v4&#34;&gt;&lt;strong&gt;lucassabreu/k8s-pr-envs&lt;/strong&gt; v4&lt;/a&gt;&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;Um comportamento que ainda n√£o conseguimos reproduzir usando o Buddy e GitHub √© destruir os ambientes quando o Pull Request √© finalizado.&lt;/p&gt;

&lt;p&gt;Para resolver esse problema podemos adicionar um webhook no GitHub e dispararmos o pipeline atrav√©s desse webhook. Isso pode ser feito de v√°rias formas, usando Lambda Functions ou um endpoint para esse fim.&lt;/p&gt;

&lt;p&gt;No caso criei um novo Pod com um cont√™iner que criei (&lt;code&gt;lucassabreu/buddy-works-pullrequest-webhook&lt;/code&gt;) e associei ela no meu projeto no GitHub.&lt;/p&gt;


&lt;figure class=&#34;big&#34;&gt;
  
    
      &lt;img class=&#34;lazyload&#34; data-src=&#34;/post/ambientes-por-branch-com-openshift-next-gen-usando-github/webhooks.png&#34;  /&gt;
    
  
  
&lt;/figure&gt;
&lt;style media=&#34;screen&#34;&gt;
  .blur-up {
    -webkit-filter: blur(5px);
    filter: blur(5px);
    transition: filter 400ms, -webkit-filter 400ms;
  }
  .blur-up.lazyloaded {
    -webkit-filter: blur(0);
    filter: blur(0);
  }
&lt;/style&gt;


&lt;p&gt;E pronto tenho um processo completo, mesmo que se esque√ßam de derrubar o ambiente no momento que o merge acontecer automaticamente o ambiente
ser√° destru√≠do.&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;Abaixo esta o meu &amp;ldquo;webhook&amp;rdquo; caso opte por um caminho semelhante e poder
ter uma base de como √© a chamada.&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;https://github.com/lucassabreu/buddy-works-pullrequest-webhook&#34;&gt;&lt;strong&gt;lucassabreu/buddy-works-pullrequest-webhook&lt;/strong&gt;&lt;/a&gt;&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;Foi mais complexo implementar a integra√ß√£o do OpenShift com o GitHub, mas ainda sim temos um grande ecossistema de integra√ß√µes que nos permitem contornar essa quest√£o, e o resultado continua sendo o esperado.&lt;/p&gt;</description>
    </item>
    
    <item>
      <title>Ambientes por Branch com OpenShift Next¬†Gen</title>
      <link>https://lucassabreu.net.br/post/ambientes-por-branch-com-openshift-next-gen/</link>
      <pubDate>Mon, 01 May 2017 00:00:00 +0000</pubDate>
      
      <guid>https://lucassabreu.net.br/post/ambientes-por-branch-com-openshift-next-gen/</guid>
      <description>&lt;p&gt;&lt;/p&gt;


&lt;figure class=&#34;big&#34;&gt;
  
    
      &lt;img class=&#34;lazyload&#34; data-src=&#34;/post/ambientes-por-branch-com-openshift-next-gen/header.png&#34;  /&gt;
    
  
  
&lt;/figure&gt;
&lt;style media=&#34;screen&#34;&gt;
  .blur-up {
    -webkit-filter: blur(5px);
    filter: blur(5px);
    transition: filter 400ms, -webkit-filter 400ms;
  }
  .blur-up.lazyloaded {
    -webkit-filter: blur(0);
    filter: blur(0);
  }
&lt;/style&gt;


&lt;p&gt;Hoje na &lt;a href=&#34;https://blog.coderockr.com&#34;&gt;Coderockr&lt;/a&gt; utilizamos &lt;a href=&#34;https://blog.coderockr.com/a-import%C3%A2ncia-da-revis%C3%A3o-de-c%C3%B3digo-a1a8b41ed7ff&#34;&gt;Pull Requests e Code Reviews&lt;/a&gt; como uma ferramenta de qualidade nos nossos desenvolvimentos, e tem garantido resultados nesse sentido.&lt;/p&gt;

&lt;p&gt;Mas mesmo com esse processo eventualmente temos de lidar com alguns problemas como, por exemplo, fun√ß√µes que interferem umas nas outras depois de aprovadas, permitir que os Testers possam avaliar as melhorias, e garantir que todos as mudan√ßas feitas na branch principal podem ser enviadas para produ√ß√£o.&lt;/p&gt;

&lt;p&gt;Esses problemas podem ser reduzidos, ou at√© eliminados; se, mesmo antes de aprovar os PRs; os Testers conseguissem trabalhar sobre essas melhorias e s√≥ repassadas para a branch principal ap√≥s a aprova√ß√£o deles.&lt;/p&gt;

&lt;p&gt;Desse modo o fonte principal n√£o s√≥ passou pelo Review de outros desenvolvedores, como foi testado pela equipe de QA, dando ainda mais confian√ßa no mesmo.&lt;/p&gt;

&lt;p&gt;Mas subir ambientes de homologa√ß√£o para cada um dos PRs, automaticamente ou sobre demanda, n√£o √© um problema trivial, envolve subir m√°quinas, garantir que esta rodando a vers√£o atualizada, liberar portas, etc.&lt;/p&gt;

&lt;p&gt;Uma forma que encontramos para resolver esse problema √© utilizando um cluster Kubernetes (ou a vers√£o da Red Hat o OpenShift), pois essas a√ß√µes s√£o bem simples de realizar com ele e ainda mais f√°ceis se forem automatizadas.&lt;/p&gt;

&lt;p&gt;Agora vou explicar como montar um exemplo simples, um para o GitLab e outro para o GitHub, integrando com o OpenShift da &lt;a href=&#34;https://getupcloud.com.br&#34;&gt;Getup Cloud&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Sobre uma introdu√ß√£o ao Kubernetes/OpenShift pode ver aqui:&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;https://lucassabreu.net.br/post/um-ambiente-simples-usando-kubernetes-e-openshift-next-gen-parte-1/&#34;&gt;&lt;strong&gt;Um ambiente simples usando Kubernetes e OpenShift Next Gen‚Ää-‚ÄäParte 1&lt;/strong&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;O cliente de linha de comando pode ser baixado em:&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;https://github.com/openshift/origin/releases&#34;&gt;&lt;strong&gt;openshift/origin&lt;/strong&gt; origin - Enterprise Kubernetes for Developers&lt;/a&gt;&lt;/p&gt;

&lt;h4 id=&#34;gitlab-integrations-ci-registry-e-environments&#34;&gt;GitLab: Integrations, CI, Registry e Environments&lt;/h4&gt;


&lt;figure class=&#34;big&#34;&gt;
  
    
      &lt;img class=&#34;lazyload&#34; data-src=&#34;/post/ambientes-por-branch-com-openshift-next-gen/gitlab.png&#34;  /&gt;
    
  
  
&lt;/figure&gt;
&lt;style media=&#34;screen&#34;&gt;
  .blur-up {
    -webkit-filter: blur(5px);
    filter: blur(5px);
    transition: filter 400ms, -webkit-filter 400ms;
  }
  .blur-up.lazyloaded {
    -webkit-filter: blur(0);
    filter: blur(0);
  }
&lt;/style&gt;


&lt;p&gt;A primeira experiencia que fizemos foi com o &lt;a href=&#34;https://gitlab.com&#34;&gt;GitLab&lt;/a&gt;, principalmente pela integra√ß√£o que ele traz com o Kubernetes, e as outras ferramentas que ele oferece que acabaram cobrindo todo o escopo do problema.&lt;/p&gt;

&lt;p&gt;O que queremos montar √© um ambiente por branch/PR que deve ser facilmente criado e destru√≠do. Para demonstrar criei um reposit√≥rio no GitLab com uma aplica√ß√£o bem simples que apenas retorna uma p√°gina est√°tica, mas √© o suficiente para o objetivo.&lt;/p&gt;


&lt;figure &gt;
  
    
      &lt;img class=&#34;lazyload&#34; data-src=&#34;/post/ambientes-por-branch-com-openshift-next-gen/helloworld-view.png&#34;  /&gt;
    
  
  
  &lt;figcaption&gt;
    &lt;header&gt;&lt;b&gt;retorno do servi√ßo helloworld&lt;/b&gt;&lt;/header&gt;
    
  &lt;/figcaption&gt;
  
&lt;/figure&gt;
&lt;style media=&#34;screen&#34;&gt;
  .blur-up {
    -webkit-filter: blur(5px);
    filter: blur(5px);
    transition: filter 400ms, -webkit-filter 400ms;
  }
  .blur-up.lazyloaded {
    -webkit-filter: blur(0);
    filter: blur(0);
  }
&lt;/style&gt;


&lt;p&gt;Primeiramente criei a base da aplica√ß√£o usando Docker, a mesma gera uma p√°gina com o conte√∫do acima. O que vale destacar nesse primeiro momento √© que j√° configurei um processo de CI simples:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #272822&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #ae81ff&#34;&gt;build&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;image&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;docker:latest&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;services&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
    &lt;span style=&#34;color: #f8f8f2&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;docker:dind&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;stage&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;build&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;script&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
    &lt;span style=&#34;color: #f8f8f2&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;docker login -u &amp;quot;gitlab-ci-token&amp;quot; -p &amp;quot;$CI_JOB_TOKEN&amp;quot; $CI_REGISTRY&lt;/span&gt;
    &lt;span style=&#34;color: #f8f8f2&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;docker build --pull -t &amp;quot;$CI_REGISTRY_IMAGE:$CI_COMMIT_REF_NAME&amp;quot; .&lt;/span&gt;
    &lt;span style=&#34;color: #f8f8f2&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;docker push &amp;quot;$CI_REGISTRY_IMAGE:$CI_COMMIT_REF_NAME&amp;quot;&lt;/span&gt;
    &lt;span style=&#34;color: #f8f8f2&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;echo &amp;quot;Pushing image $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_NAME&amp;quot;&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;only&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
    &lt;span style=&#34;color: #f8f8f2&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;branches&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;p class=&#34;code-legend&#34;&gt;.gitlab-ci.yml&lt;/p&gt;

&lt;p&gt;Nesse CI eu construo o cont√™iner da aplica√ß√£o para cada commit feito e guardo no registro do pr√≥prio GitLab por branch, dessa forma tenho uma vers√£o do meu cont√™iner para cada uma das branchs que forem criadas e vou atualizando essas vers√µes automaticamente a cada altera√ß√£o.&lt;/p&gt;

&lt;p&gt;Fonte completo at√© aqui:&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;https://gitlab.com/lucassabreu/k8s-pr-envs/tree/v1&#34;&gt;&lt;strong&gt;Files ¬∑ v1 ¬∑ Lucas dos Santos Abreu / k8s-pr-envs&lt;/strong&gt;&lt;/a&gt;&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;Nesse momento n√£o tenho nenhum deploy, seja de ambiente de teste, produ√ß√£o ou por branch.&lt;/p&gt;

&lt;p&gt;Ent√£o vamos adicionar um processo de deploy no OpenShift para o ambiente de produ√ß√£o e testes, sendo que o ambiente de testes √© atualizado automaticamente para os commits na master e o de produ√ß√£o apenas quando um usu√°rio disparar o deploy.&lt;/p&gt;

&lt;p&gt;Para fazer isso primeiramente temos de configurar a integra√ß√£o entre o OpenShift e o GitLab, para isso vamos em &lt;em&gt;Settings&lt;/em&gt; &amp;gt; &lt;em&gt;Integrations&lt;/em&gt; e procuramos &lt;em&gt;Kubernetes&lt;/em&gt; nas op√ß√µes. O GitLab ir√° solicitar algumas informa√ß√µes sobre o ambiente, qual o &lt;strong&gt;Namespace&lt;/strong&gt;, o &lt;strong&gt;URL da API&lt;/strong&gt; do &lt;strong&gt;Kubernetes&lt;/strong&gt; e uma forma de autentica√ß√£o, que pode ser um &lt;strong&gt;Service Token&lt;/strong&gt; ou um &lt;strong&gt;CA Bundle&lt;/strong&gt;.&lt;/p&gt;

&lt;p&gt;Dessa forma vou criar um novo &lt;strong&gt;Namespace&lt;/strong&gt;, como fazer isso vai depender do seu vendor de Kubernetes, no caso da &lt;a href=&#34;https://getupcloud.com.br&#34;&gt;Getup Cloud&lt;/a&gt;, basta ir em &lt;a href=&#34;https://portal.getupcloud.com/projects&#34;&gt;https://portal.getupcloud.com/projects&lt;/a&gt; e criar um novo projeto, o nome do projeto ser√° o &lt;strong&gt;Namespace.&lt;/strong&gt;&lt;/p&gt;


&lt;figure class=&#34;big&#34;&gt;
  
    
      &lt;img class=&#34;lazyload&#34; data-src=&#34;/post/ambientes-por-branch-com-openshift-next-gen/dashboard-getup.png&#34;  /&gt;
    
  
  
&lt;/figure&gt;
&lt;style media=&#34;screen&#34;&gt;
  .blur-up {
    -webkit-filter: blur(5px);
    filter: blur(5px);
    transition: filter 400ms, -webkit-filter 400ms;
  }
  .blur-up.lazyloaded {
    -webkit-filter: blur(0);
    filter: blur(0);
  }
&lt;/style&gt;


&lt;p&gt;Uma vez com o &lt;strong&gt;Namespace&lt;/strong&gt; podemos criar um novo &lt;strong&gt;Service Token&lt;/strong&gt; para ser usado no CI do GitLab, no caso para criar um Service Token √© necess√°rio criar uma ServiceAccount e dar permiss√µes a mesma, e ent√£o pegar o Service Token dela. O script abaixo realiza essas opera√ß√µes:&lt;/p&gt;

&lt;pre&gt;
&lt;b&gt;$ oc login https://api.getupcloud.com:443&lt;/b&gt;
Authentication required for https://api.getupcloud.com:443 ...
Username: lucas.s.abreu@gmail.com
Password:
Login successful.
...

&lt;b&gt;$ oc project gitlab-k8s-pr-envs #usar o seu projeto&lt;/b&gt;
Now using project &#34;gitlab-k8s-pr-envs&#34; on server ...

&lt;b&gt;$ oc create serviceaccount gitlab&lt;/b&gt;
serviceaccount &#34;gitlab&#34; created

&lt;b&gt;$ oc policy add-role-to-user admin \&lt;/b&gt;
    system:serviceaccount:gitlab-k8s-pr-envs:gitlab

&lt;b&gt;$ oc describe serviceaccount gitlab&lt;/b&gt;
Name:  gitlab
Namespace: gitlab-k8s-pr-envs
Labels:  &lt;none&gt;

Image pull secrets: gitlab-dockercfg-qj9o9

Mountable secrets:  gitlab-token-6ael2
                    gitlab-dockercfg-qj9o9

Tokens:             gitlab-token-6ael2
                    gitlab-token-zkk6u

&lt;b&gt;$ oc describe secret gitlab-token-6ael2&lt;/b&gt;
Name:  gitlab-token-6ael2
Namespace: gitlab-k8s-pr-envs
Labels:  &lt;none&gt;
Annotations: kubernetes.io/service-account.name=gitlab
  kubernetes.io/service-account.uid=zzz

Type: kubernetes.io/service-account-token

Data
====
ca.crt:  1066 bytes
namespace: 18 bytes
service-ca.crt: 2182 bytes
token:  &lt;i&gt;&lt;b&gt;token-do-openshift-que-estou-ocultando&lt;/i&gt;&lt;/b&gt;
&lt;/pre&gt;

&lt;p&gt;Agora que temos o token gerado basta adicionar essas informa√ß√µes no
GitLab.&lt;/p&gt;


&lt;figure class=&#34;big&#34;&gt;
  
    
      &lt;img class=&#34;lazyload&#34; data-src=&#34;/post/ambientes-por-branch-com-openshift-next-gen/gitlab-k8s-integration.png&#34;  /&gt;
    
  
  
&lt;/figure&gt;
&lt;style media=&#34;screen&#34;&gt;
  .blur-up {
    -webkit-filter: blur(5px);
    filter: blur(5px);
    transition: filter 400ms, -webkit-filter 400ms;
  }
  .blur-up.lazyloaded {
    -webkit-filter: blur(0);
    filter: blur(0);
  }
&lt;/style&gt;


&lt;p&gt;Voc√™ pode confirmar se passou os dados corretos com o bot√£o de teste no GitLab.&lt;/p&gt;

&lt;p&gt;Certo, agora o GitLab consegue conversar com o OpenShift. Podemos ent√£o alterar nossas regras de CI para criar duas novas etapas: &lt;em&gt;staging&lt;/em&gt; e &lt;em&gt;production&lt;/em&gt;, que ir√£o realizar o deploy dos nossos ambientes padr√µes, sendo que &lt;em&gt;staging&lt;/em&gt; ser√° disparada automaticamente por commits na master e &lt;em&gt;production&lt;/em&gt; ficar√° como manual.&lt;/p&gt;

&lt;p&gt;O¬†.&lt;code&gt;gitlab-ci.yml&lt;/code&gt; ficou como abaixo (j√° usando a integra√ß√£o com OpenShift):&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #272822&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #ae81ff&#34;&gt;stages&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
  &lt;span style=&#34;color: #f8f8f2&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;build&lt;/span&gt;
  &lt;span style=&#34;color: #f8f8f2&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;staging&lt;/span&gt;
  &lt;span style=&#34;color: #f8f8f2&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;production&lt;/span&gt;

&lt;span style=&#34;color: #ae81ff&#34;&gt;variables&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;KUBE_DOMAIN&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;getup.io&lt;/span&gt;

&lt;span style=&#34;color: #ae81ff&#34;&gt;build&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;stage&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;build&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;image&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;docker:latest&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;services&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
    &lt;span style=&#34;color: #f8f8f2&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;docker:dind&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;script&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
    &lt;span style=&#34;color: #f8f8f2&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;docker login -u &amp;quot;gitlab-ci-token&amp;quot; -p &amp;quot;$CI_JOB_TOKEN&amp;quot; $CI_REGISTRY&lt;/span&gt;
    &lt;span style=&#34;color: #f8f8f2&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;docker build --pull -t &amp;quot;$CI_REGISTRY_IMAGE:$CI_COMMIT_REF_NAME&amp;quot; .&lt;/span&gt;
    &lt;span style=&#34;color: #f8f8f2&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;docker push &amp;quot;$CI_REGISTRY_IMAGE:$CI_COMMIT_REF_NAME&amp;quot;&lt;/span&gt;
    &lt;span style=&#34;color: #f8f8f2&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;echo &amp;quot;Pushing image $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_NAME&amp;quot;&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;only&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
    &lt;span style=&#34;color: #f8f8f2&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;branches&lt;/span&gt;

&lt;span style=&#34;color: #ae81ff&#34;&gt;staging&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;stage&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;staging&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;image&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;lucassabreu/openshift-k8s-cli:latest&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;variables&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
    &lt;span style=&#34;color: #ae81ff&#34;&gt;CI_ENVIRONMENT_URL&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;http://$CI_PROJECT_NAME-staging.$KUBE_DOMAIN&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;environment&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
    &lt;span style=&#34;color: #ae81ff&#34;&gt;name&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;staging&lt;/span&gt;
    &lt;span style=&#34;color: #ae81ff&#34;&gt;url&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;http://$CI_PROJECT_NAME-staging.$KUBE_DOMAIN&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;script&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
    &lt;span style=&#34;color: #f8f8f2&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;k8s/deploy&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;only&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
    &lt;span style=&#34;color: #f8f8f2&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;master&lt;/span&gt;

&lt;span style=&#34;color: #ae81ff&#34;&gt;production&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;stage&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;production&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;image&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;lucassabreu/openshift-k8s-cli:latest&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;variables&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
    &lt;span style=&#34;color: #ae81ff&#34;&gt;CI_ENVIRONMENT_URL&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;http://$CI_PROJECT_NAME.$KUBE_DOMAIN&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;environment&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
    &lt;span style=&#34;color: #ae81ff&#34;&gt;name&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;production&lt;/span&gt;
    &lt;span style=&#34;color: #ae81ff&#34;&gt;url&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;http://$CI_PROJECT_NAME.$KUBE_DOMAIN&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;when&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;manual&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;script&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
    &lt;span style=&#34;color: #f8f8f2&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;k8s/deploy&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;only&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
    &lt;span style=&#34;color: #f8f8f2&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;master&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;p class=&#34;code-legend&#34;&gt;.gitlab-ci.yml (v2)&lt;/p&gt;

&lt;p&gt;As mudan√ßa s√£o os novos stages &lt;code&gt;staging&lt;/code&gt; e &lt;code&gt;production&lt;/code&gt;; as vari√°veis novas &lt;code&gt;KUBE_DOMAIN&lt;/code&gt; e &lt;code&gt;CI_ENVIRONMENT_URL&lt;/code&gt;; e o script &lt;code&gt;k8s/deploy&lt;/code&gt;. Vamos por partes.&lt;/p&gt;

&lt;p&gt;A vari√°vel &lt;code&gt;KUBE_DOMAIN&lt;/code&gt; vai ajudar a deixar o nosso processo de deploy mais simples, basicamente n√≥s colocamos nela o dom√≠nio base que o OpenShift usa para expor as rotas dele, no caso da Getup seria &amp;ldquo;&lt;em&gt;getup.io&lt;/em&gt;&amp;rdquo;. A &lt;code&gt;CI_ENVIRONMENT_URL&lt;/code&gt; √© completar a &lt;code&gt;KUBE_DOMAIN&lt;/code&gt; e serve para informar o &lt;code&gt;k8s/deploy&lt;/code&gt; qual endere√ßo ele deve expor o ambiente, ele deve sempre terminar com o &lt;code&gt;KUBE_DOMAIN&lt;/code&gt; e deve ser igual a &lt;code&gt;url&lt;/code&gt; da chave &lt;code&gt;environment&lt;/code&gt;, pois √© por essa chave que o GitLab sabe onde os ambientes est√£o expostos.&lt;/p&gt;

&lt;p&gt;As etapas de &lt;code&gt;staging&lt;/code&gt; e &lt;code&gt;production&lt;/code&gt; ir√£o fazer o deploy dos nossos ambientes e como comentei antes o ambiente de &lt;em&gt;staging&lt;/em&gt; ter√° deploy autom√°tico para todo commit na master, enquanto &lt;em&gt;production&lt;/em&gt; ir√° esperar uma a√ß√£o do usu√°rio. No mais as duas etapas s√£o iguais mudando apenas a URL que est√£o sendo expostas. Estou usando a imagem &lt;code&gt;lucassabreu/openshift-k8s-cli&lt;/code&gt; que √© basicamente um &lt;code&gt;ubuntu&lt;/code&gt; com o &lt;code&gt;oc&lt;/code&gt; instalado.&lt;/p&gt;

&lt;p&gt;O script &lt;code&gt;k8s/deploy&lt;/code&gt; est√° abaixo e ele basicamente se autentica contra a API do OpenShift usando o &lt;em&gt;Service Token&lt;/em&gt; que criamos antes, destr√≥i a aplica√ß√£o antiga e executa o deploy de uma nova.&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #272822&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #75715e&#34;&gt;#!/bin/bash&lt;/span&gt;

oc login &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;$KUBE_URL&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;&lt;/span&gt; --token &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;$KUBE_TOKEN&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;&lt;/span&gt;
oc project &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;$KUBE_NAMESPACE&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;&lt;/span&gt;

&lt;span style=&#34;color: #f8f8f2&#34;&gt;HOSTNAME&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;$CI_ENVIRONMENT_URL&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;&lt;/span&gt;

&lt;span style=&#34;color: #75715e&#34;&gt;# remove protocol from URL&lt;/span&gt;
&lt;span style=&#34;color: #f8f8f2&#34;&gt;HOSTNAME&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;${&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;HOSTNAME/&lt;/span&gt;&lt;span style=&#34;color: #ae81ff&#34;&gt;\h&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;ttp:&lt;/span&gt;&lt;span style=&#34;color: #ae81ff&#34;&gt;\/\/&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;/&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;}&amp;quot;&lt;/span&gt;
&lt;span style=&#34;color: #f8f8f2&#34;&gt;HOSTNAME&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;${&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;HOSTNAME/&lt;/span&gt;&lt;span style=&#34;color: #ae81ff&#34;&gt;\h&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;ttp:&lt;/span&gt;&lt;span style=&#34;color: #ae81ff&#34;&gt;\/\/&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;/&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;}&amp;quot;&lt;/span&gt;

&lt;span style=&#34;color: #f8f8f2&#34;&gt;IMAGE_TAG&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;$CI_REGISTRY_IMAGE&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;$CI_BUILD_REF_NAME&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;&lt;/span&gt;
&lt;span style=&#34;color: #f8f8f2&#34;&gt;ENV&lt;/span&gt;&lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;$CI_ENVIRONMENT_SLUG&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;&lt;/span&gt;

&lt;span style=&#34;color: #f8f8f2&#34;&gt;echo&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;&amp;gt;&amp;gt; Deleting old application...&amp;quot;&lt;/span&gt;
oc delete all -l &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;app=&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;$CI_ENVIRONMENT_SLUG&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;&lt;/span&gt;

&lt;span style=&#34;color: #f8f8f2&#34;&gt;echo&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;&amp;gt;&amp;gt; Deploying image &lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;$IMAGE_TAG&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt; to env &lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;$ENV&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt; at &lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;$HOSTNAME&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;...&amp;quot;&lt;/span&gt;

sed &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;&lt;/span&gt;
&lt;span style=&#34;color: #e6db74&#34;&gt;  s|__HOSTNAME__|&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;$HOSTNAME&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;|;&lt;/span&gt;
&lt;span style=&#34;color: #e6db74&#34;&gt;  s|__ENV__|&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;$ENV&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;|;&lt;/span&gt;
&lt;span style=&#34;color: #e6db74&#34;&gt;  s|__IMAGE_TAG__|&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;$IMAGE_TAG&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;|;&lt;/span&gt;
&lt;span style=&#34;color: #e6db74&#34;&gt;  &amp;quot;&lt;/span&gt; k8s/full.yml &lt;span style=&#34;color: #f8f8f2&#34;&gt;|&lt;/span&gt; oc apply -f -
&lt;span style=&#34;color: #66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;[&lt;/span&gt; &lt;span style=&#34;color: #f8f8f2&#34;&gt;$?&lt;/span&gt; !&lt;span style=&#34;color: #f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;0&lt;/span&gt; &lt;span style=&#34;color: #f92672&#34;&gt;]&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;;&lt;/span&gt; &lt;span style=&#34;color: #66d9ef&#34;&gt;then&lt;/span&gt;
  &lt;span style=&#34;color: #f8f8f2&#34;&gt;exit&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;1&lt;/span&gt;
&lt;span style=&#34;color: #66d9ef&#34;&gt;fi&lt;/span&gt;

&lt;span style=&#34;color: #f8f8f2&#34;&gt;echo&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;&amp;gt;&amp;gt; Deployed to &lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;$CI_ENVIRONMENT_URL&lt;/span&gt;&lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;p class=&#34;code-legend&#34;&gt;k8s/deploy&lt;/p&gt;

&lt;p&gt;Vale ressaltar que √© importante marcar os componentes do ambiente com &lt;code&gt;app=$CI_ENVIRONMENT_SLUG&lt;/code&gt;, pois √© assim que o GitLab consegue encontrar eles e lhe retornar status sobre eles.&lt;/p&gt;

&lt;p&gt;Tamb√©m estou usando um truque de &amp;ldquo;templating&amp;rdquo; com o YAML que define os ambientes para poder inserir as vari√°veis de cada ambiente nele. Existem outras ferramentas mais avan√ßadas como o &lt;a href=&#34;https://github.com/kubernetes/helm&#34;&gt;Helm&lt;/a&gt;, mas para o meu exemplo templating com &lt;code&gt;sed&lt;/code&gt; √© o suficiente.&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #272822&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #ae81ff&#34;&gt;apiVersion&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;extensions/v1beta1&lt;/span&gt;
&lt;span style=&#34;color: #ae81ff&#34;&gt;kind&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;Deployment&lt;/span&gt;
&lt;span style=&#34;color: #ae81ff&#34;&gt;metadata&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;name&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;hw-dpl-__ENV__&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;labels&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
    &lt;span style=&#34;color: #ae81ff&#34;&gt;app&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;__ENV__&lt;/span&gt;
&lt;span style=&#34;color: #ae81ff&#34;&gt;spec&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;replicas&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;1&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;template&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
    &lt;span style=&#34;color: #ae81ff&#34;&gt;metadata&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
      &lt;span style=&#34;color: #ae81ff&#34;&gt;labels&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
        &lt;span style=&#34;color: #ae81ff&#34;&gt;app&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;__ENV__&lt;/span&gt;
        &lt;span style=&#34;color: #ae81ff&#34;&gt;name&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;hw-pod&lt;/span&gt;
    &lt;span style=&#34;color: #ae81ff&#34;&gt;spec&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
      &lt;span style=&#34;color: #ae81ff&#34;&gt;containers&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
      &lt;span style=&#34;color: #f8f8f2&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;name&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;hw-container&lt;/span&gt;
        &lt;span style=&#34;color: #ae81ff&#34;&gt;image&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;__IMAGE_TAG__&lt;/span&gt;
        &lt;span style=&#34;color: #ae81ff&#34;&gt;imagePullPolicy&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;Always&lt;/span&gt;
        &lt;span style=&#34;color: #ae81ff&#34;&gt;ports&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
        &lt;span style=&#34;color: #f8f8f2&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;name&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;web-port&lt;/span&gt;
          &lt;span style=&#34;color: #ae81ff&#34;&gt;containerPort&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;8080&lt;/span&gt;
&lt;span style=&#34;color: #f8f8f2&#34;&gt;---&lt;/span&gt;
&lt;span style=&#34;color: #ae81ff&#34;&gt;apiVersion&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;v1&amp;quot;&lt;/span&gt;
&lt;span style=&#34;color: #ae81ff&#34;&gt;kind&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;Service&lt;/span&gt;
&lt;span style=&#34;color: #ae81ff&#34;&gt;metadata&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;name&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;hw-src-__ENV__&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;labels&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
    &lt;span style=&#34;color: #ae81ff&#34;&gt;app&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;__ENV__&lt;/span&gt;
&lt;span style=&#34;color: #ae81ff&#34;&gt;spec&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;ports&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
    &lt;span style=&#34;color: #f8f8f2&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;port&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;80&lt;/span&gt;
      &lt;span style=&#34;color: #ae81ff&#34;&gt;targetPort&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #e6db74&#34;&gt;&amp;quot;web-port&amp;quot;&lt;/span&gt;
      &lt;span style=&#34;color: #ae81ff&#34;&gt;protocol&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;TCP&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;selector&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
    &lt;span style=&#34;color: #ae81ff&#34;&gt;name&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;hw-pod&lt;/span&gt;
    &lt;span style=&#34;color: #ae81ff&#34;&gt;app&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;__ENV__&lt;/span&gt;
&lt;span style=&#34;color: #f8f8f2&#34;&gt;---&lt;/span&gt;
&lt;span style=&#34;color: #ae81ff&#34;&gt;apiVersion&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;v1&lt;/span&gt;
&lt;span style=&#34;color: #ae81ff&#34;&gt;kind&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;Route&lt;/span&gt;
&lt;span style=&#34;color: #ae81ff&#34;&gt;metadata&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;name&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;__ENV__&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;labels&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
    &lt;span style=&#34;color: #ae81ff&#34;&gt;app&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;__ENV__&lt;/span&gt;
&lt;span style=&#34;color: #ae81ff&#34;&gt;spec&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;host&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;__HOSTNAME__&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;to&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
    &lt;span style=&#34;color: #ae81ff&#34;&gt;kind&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;Service&lt;/span&gt;
    &lt;span style=&#34;color: #ae81ff&#34;&gt;name&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;hw-src-__ENV__&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;p class=&#34;code-legend&#34;&gt;k8s/full.yml&lt;/p&gt;

&lt;p&gt;Agora, depois que do commit das altera√ß√µes, o GitLab faz o &lt;em&gt;build&lt;/em&gt;, o deploy da &lt;em&gt;staging&lt;/em&gt; e &lt;em&gt;production&lt;/em&gt; (manual); podemos ver na √°rea &lt;em&gt;Environments&lt;/em&gt; do GitLab que os ambientes est√£o rodando, ele inclusive traz alguns comandos para facilitar a vida: link para a URL do ambiente, terminal dentro do Pod e op√ß√£o de Re-deploy.&lt;/p&gt;


&lt;figure class=&#34;big&#34;&gt;
  
    
      &lt;img class=&#34;lazyload&#34; data-src=&#34;/post/ambientes-por-branch-com-openshift-next-gen/gilab-envs.png&#34;  /&gt;
    
  
  
&lt;/figure&gt;
&lt;style media=&#34;screen&#34;&gt;
  .blur-up {
    -webkit-filter: blur(5px);
    filter: blur(5px);
    transition: filter 400ms, -webkit-filter 400ms;
  }
  .blur-up.lazyloaded {
    -webkit-filter: blur(0);
    filter: blur(0);
  }
&lt;/style&gt;


&lt;p&gt;Fonte completo at√© agora:&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;https://gitlab.com/lucassabreu/k8s-pr-envs/tree/v2&#34;&gt;&lt;strong&gt;Files ¬∑ v2 ¬∑ Lucas dos Santos Abreu / k8s-pr-envs&lt;/strong&gt;&lt;/a&gt;&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;Agora que temos o &lt;em&gt;build&lt;/em&gt; da nossa aplica√ß√£o e um deploy automatizado, vamos adicionar a fun√ß√£o de deploy por branch.&lt;/p&gt;

&lt;p&gt;Basicamente precisamos de duas novas etapas no nosso CI, uma para subir o ambiente para uma branch e outro para destruir esse ambiente para evitar consumir recursos sem necessidade.&lt;/p&gt;

&lt;p&gt;Para isso fiz as seguintes altera√ß√µes nos¬†&lt;code&gt;.gitlab-ci.yml&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #272822&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;span style=&#34;color: #ae81ff&#34;&gt;stages&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
  &lt;span style=&#34;color: #f8f8f2&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;build&lt;/span&gt;
  &lt;span style=&#34;color: #f8f8f2&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;review&lt;/span&gt;
  &lt;span style=&#34;color: #f8f8f2&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;staging&lt;/span&gt;
  &lt;span style=&#34;color: #f8f8f2&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;production&lt;/span&gt;
  &lt;span style=&#34;color: #f8f8f2&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;cleanup&lt;/span&gt;

&lt;span style=&#34;color: #ae81ff&#34;&gt;review&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;stage&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;review&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;image&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;lucassabreu/openshift-k8s-cli:latest&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;variables&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
    &lt;span style=&#34;color: #ae81ff&#34;&gt;CI_ENVIRONMENT_URL&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;http://$CI_PROJECT_NAME-$CI_ENVIRONMENT_SLUG.$KUBE_DOMAIN&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;environment&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
    &lt;span style=&#34;color: #ae81ff&#34;&gt;name&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;r/$CI_COMMIT_REF_NAME&lt;/span&gt;
    &lt;span style=&#34;color: #ae81ff&#34;&gt;url&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;http://$CI_PROJECT_NAME-$CI_ENVIRONMENT_SLUG.$KUBE_DOMAIN&lt;/span&gt;
    &lt;span style=&#34;color: #ae81ff&#34;&gt;on_stop&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;stop_review&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;script&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
    &lt;span style=&#34;color: #f8f8f2&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;k8s/deploy&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;only&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
    &lt;span style=&#34;color: #f8f8f2&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;branches&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;except&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
    &lt;span style=&#34;color: #f8f8f2&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;master&lt;/span&gt;

&lt;span style=&#34;color: #ae81ff&#34;&gt;stop_review&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;stage&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;cleanup&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;image&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;lucassabreu/openshift-k8s-cli:latest&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;environment&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
    &lt;span style=&#34;color: #ae81ff&#34;&gt;name&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;r/$CI_COMMIT_REF_NAME&lt;/span&gt;
    &lt;span style=&#34;color: #ae81ff&#34;&gt;action&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;stop&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;when&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;manual&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;variables&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
    &lt;span style=&#34;color: #ae81ff&#34;&gt;GIT_STRATEGY&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;none&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;script&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
    &lt;span style=&#34;color: #f8f8f2&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;oc login &amp;quot;$KUBE_URL&amp;quot; --token &amp;quot;$KUBE_TOKEN&amp;quot;&lt;/span&gt;
    &lt;span style=&#34;color: #f8f8f2&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;oc project &amp;quot;$KUBE_NAMESPACE&amp;quot;&lt;/span&gt;
    &lt;span style=&#34;color: #f8f8f2&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;oc delete deployments -l &amp;quot;app=$CI_ENVIRONMENT_SLUG&amp;quot;&lt;/span&gt;
    &lt;span style=&#34;color: #f8f8f2&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;oc delete all -l &amp;quot;app=$CI_ENVIRONMENT_SLUG&amp;quot;&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;only&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
    &lt;span style=&#34;color: #f8f8f2&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;branches&lt;/span&gt;
  &lt;span style=&#34;color: #ae81ff&#34;&gt;except&lt;/span&gt;&lt;span style=&#34;color: #f8f8f2&#34;&gt;:&lt;/span&gt;
    &lt;span style=&#34;color: #f8f8f2&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color: #ae81ff&#34;&gt;master&lt;/span&gt;

&lt;span style=&#34;color: #f8f8f2&#34;&gt;[...]&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;p class=&#34;code-legend&#34;&gt;.gitlab-ci.yml (v3)&lt;/p&gt;

&lt;p&gt;Basicamente adicionei as duas novas etapas, &lt;code&gt;review&lt;/code&gt; basicamente faz a mesma coisa que &lt;code&gt;staging&lt;/code&gt;, mas usa um nome de ambiente din√¢mico baseado na branch; e tem um &lt;code&gt;enviroment:on_stop&lt;/code&gt; que basicamente indica o que fazer quando a branch for removida.&lt;/p&gt;

&lt;p&gt;Na etapa &lt;code&gt;stop_review&lt;/code&gt; executo alguns comandos para eliminar o ambiente quando for chamada, √© importante deixar essa como &lt;code&gt;manual&lt;/code&gt; para que ela n√£o apague sozinha o ambiente quando terminar as outras etapas.&lt;/p&gt;

&lt;p&gt;Os comandos da etapa &lt;code&gt;stop_review&lt;/code&gt; precisam estar definidos diretamente no¬†&lt;code&gt;.gitlab-ci.yml&lt;/code&gt;, pois quando essa etapa for executada √© poss√≠vel que a branch e commits dela n√£o existam mais, √© tamb√©m por esse motivo que informamos a vari√°vel &lt;code&gt;GIT_STRATEGY&lt;/code&gt; como &lt;code&gt;NO&lt;/code&gt; evitando que sequer seja checado se a branch/commit de origem existem.&lt;/p&gt;

&lt;p&gt;Agora quando crio uma nova branch automaticamente √© criado um novo ambiente para a mesma no OpenShift.&lt;/p&gt;

&lt;p&gt;Para testar criei a branch &lt;code&gt;a-change&lt;/code&gt; e fiz a seguinte altera√ß√£o:&lt;/p&gt;
&lt;div class=&#34;highlight&#34; style=&#34;background: #272822&#34;&gt;&lt;pre style=&#34;line-height: 125%&#34;&gt;&lt;span&gt;&lt;/span&gt;   &amp;lt;img id=&amp;quot;logo&amp;quot; src=&amp;quot;logo.svg&amp;quot;
     alt=&amp;quot;CodeRocker&amp;quot; title=&amp;quot;CodeRocker&amp;quot; /&amp;gt;
   &amp;lt;h1&amp;gt;Hello World !&amp;lt;/h1&amp;gt;
&lt;span style=&#34;color: #a6e22e&#34;&gt;+  &amp;lt;h2&amp;gt;(with a change)&amp;lt;/h2&amp;gt;&lt;/span&gt;
 &amp;lt;/body&amp;gt;
 &amp;lt;/html&amp;gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;p class=&#34;code-legend&#34;&gt;public/index.html (pr)&lt;/p&gt;

&lt;p&gt;Assim que dei o &lt;code&gt;git push&lt;/code&gt; come√ßou o deploy do novo ambiente &lt;code&gt;r/a-change&lt;/code&gt;, logo que terminou pude verificar na √°rea de ambientes do GitLab que estava rodando, e tem as mesmas opera√ß√µes dispon√≠veis que os outros, mais a op√ß√£o de parada (&lt;code&gt;stop_review&lt;/code&gt;):&lt;/p&gt;


&lt;figure class=&#34;big&#34;&gt;
  
    
      &lt;img class=&#34;lazyload&#34; data-src=&#34;/post/ambientes-por-branch-com-openshift-next-gen/branch-env.png&#34;  /&gt;
    
  
  
&lt;/figure&gt;
&lt;style media=&#34;screen&#34;&gt;
  .blur-up {
    -webkit-filter: blur(5px);
    filter: blur(5px);
    transition: filter 400ms, -webkit-filter 400ms;
  }
  .blur-up.lazyloaded {
    -webkit-filter: blur(0);
    filter: blur(0);
  }
&lt;/style&gt;


&lt;p&gt;J√° rodando as altera√ß√µes:&lt;/p&gt;


&lt;figure &gt;
  
    
      &lt;img class=&#34;lazyload&#34; data-src=&#34;/post/ambientes-por-branch-com-openshift-next-gen/a-change.png&#34;  /&gt;
    
  
  
&lt;/figure&gt;
&lt;style media=&#34;screen&#34;&gt;
  .blur-up {
    -webkit-filter: blur(5px);
    filter: blur(5px);
    transition: filter 400ms, -webkit-filter 400ms;
  }
  .blur-up.lazyloaded {
    -webkit-filter: blur(0);
    filter: blur(0);
  }
&lt;/style&gt;


&lt;p&gt;Fontes com essas altera√ß√µes em:&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;https://gitlab.com/lucassabreu/k8s-pr-envs/tree/v3&#34;&gt;&lt;strong&gt;Files ¬∑ v3 ¬∑ Lucas dos Santos Abreu / k8s-pr-envs&lt;/strong&gt;&lt;/a&gt;&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;Ap√≥s essas altera√ß√µes podemos implementar a regra de merge apenas ap√≥s testes pela equipe de QA, sem interfer√™ncia de outras atividades que foram aplicadas no meio do caminho e permitindo um controle melhor sobre o que esta pronto para ir para a produ√ß√£o.&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;A postagem acabou ficando bem grande apenas para falar do processo no GitLab, por isso vou criar um segundo post sobre como fazer isso no GitHub, abaixo esta o link para ele:&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;https://lucassabreu.net.br/post/ambientes-por-branch-com-openshift-next-gen-usando-github&#34;&gt;&lt;strong&gt;Ambientes por Branch com OpenShift Next Gen usando GitHub&lt;/strong&gt;&lt;/a&gt;&lt;/p&gt;</description>
    </item>
    
    <item>
      <title>Simplificando o Setup de Projetos no GitHub</title>
      <link>https://lucassabreu.net.br/post/simplificando-setup-projetos-github/</link>
      <pubDate>Tue, 10 Jan 2017 00:00:00 +0000</pubDate>
      
      <guid>https://lucassabreu.net.br/post/simplificando-setup-projetos-github/</guid>
      <description>&lt;p&gt;&lt;/p&gt;

&lt;p&gt;Na &lt;a href=&#34;http://blog.coderockr.com/&#34;&gt;Coderockr&lt;/a&gt; iniciamos e assumimos v√°rios projetos, sejam para clientes que nos contratam ou para a√ß√µes internas, e normalmente o &lt;a href=&#34;http://github.com&#34;&gt;GitHub&lt;/a&gt; acaba sendo a ferramenta escolhida para eles.&lt;/p&gt;

&lt;p&gt;E ao longo dos anos acabamos definindo uma estrutura para controlarmos as nossas issues, usando as seguintes labels:&lt;/p&gt;


&lt;figure &gt;
  
    
      &lt;img class=&#34;lazyload&#34; data-src=&#34;/post/simplificando-setup-projetos-github/labels.png&#34;  /&gt;
    
  
  
  &lt;figcaption&gt;
    &lt;header&gt;&lt;b&gt;Conjunto de labels utilizadas no Coderockr Way&lt;/b&gt;&lt;/header&gt;
    
  &lt;/figcaption&gt;
  
&lt;/figure&gt;
&lt;style media=&#34;screen&#34;&gt;
  .blur-up {
    -webkit-filter: blur(5px);
    filter: blur(5px);
    transition: filter 400ms, -webkit-filter 400ms;
  }
  .blur-up.lazyloaded {
    -webkit-filter: blur(0);
    filter: blur(0);
  }
&lt;/style&gt;


&lt;p&gt;√â um conjunto bem simples, mas que deixa bem claro as etapas, prioridades, tipos e estados das tarefas, de forma que fica bem f√°cil de acompanh√°-las.&lt;/p&gt;

&lt;p&gt;Em todos os projetos cadastramos essas labels. Mas mesmo que voc√™ esteja de bom humor, vai ser um trabalho chato e moroso. E √© bem prov√°vel que esque√ßa alguma delas, e precise revisar a lista para garantir que est√£o todas l√°.&lt;/p&gt;


&lt;figure &gt;
  
    
      &lt;img class=&#34;lazyload&#34; data-src=&#34;/post/simplificando-setup-projetos-github/looking-for.gif&#34;  /&gt;
    
  
  
  &lt;figcaption&gt;
    &lt;header&gt;&lt;b&gt;Esqueci o &amp;#34;Stage: Testing&amp;#34;? Achei...&lt;/b&gt;&lt;/header&gt;
    
  &lt;/figcaption&gt;
  
&lt;/figure&gt;
&lt;style media=&#34;screen&#34;&gt;
  .blur-up {
    -webkit-filter: blur(5px);
    filter: blur(5px);
    transition: filter 400ms, -webkit-filter 400ms;
  }
  .blur-up.lazyloaded {
    -webkit-filter: blur(0);
    filter: blur(0);
  }
&lt;/style&gt;


&lt;p&gt;Pensando nessa monotonia e para economizar algum tempo de setup nos projetos resolvemos criar um script que fizesse esse processo, adicionando as labels a um projeto que fosse informado.&lt;/p&gt;

&lt;p&gt;O script acabou ficando bem mais simples que o esperado gra√ßas a simplicidade da API do GitHub, todo ele foi feito com cURL e alguns loops no bash para as labels.&lt;/p&gt;

&lt;p&gt;At√© preparamos ele para n√£o precisar ser baixado/instalado, basta dar um cURL direto do reposit√≥rio do GitHub que ele pede os dados que precisa.&lt;/p&gt;


&lt;figure &gt;
  
    
      &lt;img class=&#34;lazyload&#34; data-src=&#34;/post/simplificando-setup-projetos-github/no-need-for-downloads.png&#34;  /&gt;
    
  
  
  &lt;figcaption&gt;
    &lt;header&gt;&lt;b&gt;nem precisa baixar&lt;/b&gt;&lt;/header&gt;
    
  &lt;/figcaption&gt;
  
&lt;/figure&gt;
&lt;style media=&#34;screen&#34;&gt;
  .blur-up {
    -webkit-filter: blur(5px);
    filter: blur(5px);
    transition: filter 400ms, -webkit-filter 400ms;
  }
  .blur-up.lazyloaded {
    -webkit-filter: blur(0);
    filter: blur(0);
  }
&lt;/style&gt;


&lt;p&gt;Resolvemos deixar o script que criamos em um reposit√≥rio p√∫blico no GitHub para quem estiver procurando uma solu√ß√£o parecida (ou que agora acha que vale a pena criar um tamb√©m).&lt;/p&gt;

&lt;p&gt;O script e como us√°-lo est√£o aqui:&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;https://github.com/Coderockr/coderockr-way-github-setup&#34;&gt;&lt;strong&gt;Coderockr/coderockr-way-github-setup&lt;/strong&gt; - Basic setup to use the Coderockr Way methodology&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Conclus√£o, investir um pouco de tempo para entender as ferramentas que voc√™ usa, n√£o s√≥ te poupa tempo a longo prazo, quanto tamb√©m gera uns scripts legais de compartilhar :)&lt;/p&gt;</description>
    </item>
    
  </channel>
</rss>